var g_iterpw=null,jj="",allowmultifactortrust=!0,hidemultifactordisable=!1;
function lplogincheck2(a,c,b,d){console_log("server.js : lplogincheck fromwebsite="+a+" sessionid="+c);if(!skiplogin()){can_chrome_do_math()||openURL(getchromeurl("mathfail.html"));yubikey_cleardata();googleauth_cleardata();outofband_cleardata();securityquestion_cleardata();sesame_cleardata();grid_cleardata();multifactor_cleardata();loginoffline(!0,"logincheck");var e="canexpire=1&cansetuuid=1&method="+encodeURIComponent(get_method())+"&version="+lpversion,e=e+get_devicetype_param();c&&(e+="&sessionid="+
LP.en(c));b&&(e+="&wxusername="+LP.en(b));d&&(e+="&wxhash="+LP.en(d));g_lastpoll=lastlogin=(new Date).getTime();c=1==lpGetPref("logoffWhenCloseBrowser",0)&&0==lpGetPref("logoffWhenCloseBrowserVal",0)?"1":"0";e+="&sessonly="+en(c);console_log("logincheck getting uuid");getuuid(function(b){console_log("logincheck got uuid");if("object"===typeof b){var c=0,d;for(d in b)e+="&uuid"+c+"="+en(b[d]),++c}else e+="&uuid="+en(b);sesame_setdata("logincheckpostdata",e);lpdbg("login","Making login check request");
lpMakeRequest(base_url+"login_check.php",e,lpLoginCheckResponse,lpLoginCheckError,a)},g_username_hash)}}function lplogincheck(a,c,b,d){lplogincheck2(a,c,b,d)}
function LP_do_login(a,c,b,d,e,f,g,h){function k(b){getBG().make_lp_key_hash_iterations(b,c,get_key_iterations(a),function(a,b){localStorage_setItem("LPMPU",q);protect_data(b,!0,null,function(a){localStorage_setItem(q+"LPMPH",a)})})}if(!skiplogin())if(g){lppassusernamehash&&!lploggedin&&lpnp_notify("login",{data0:a,data1:c});if(!e){var j=opendb();createSavedLoginsTable(j);if(j&&"undefined"!=typeof b&&null!=b){var l=d?c:"";protect_data(l,!1,a,function(c){if(b&&check_email(a)){var d=c!=l?1:0;!d&&""!=
l&&(c=lpenc(c,AES.hex2bin(SHA256(a))),d=2);console_log("server.js : saving login credentials");var e=(new Date).getTime();g_indexeddb?j.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").put({username:a,password:c,last_login:e,"protected":d}):j.transaction(function(b){b.executeSql("REPLACE INTO LastPassSavedLogins2 (username, password, last_login, protected) VALUES(?, ?, ?, ?)",[a,c,e,d],function(){},function(a,b){console_log(b)})})}else if(g_indexeddb)j.transaction("LastPassSavedLogins2",
"readwrite").objectStore("LastPassSavedLogins2")["delete"](a);else j.transaction(function(b){b.executeSql("DELETE FROM LastPassSavedLogins2 WHERE username=?",[a],function(){},function(a,b){console_log(b)})})})}"undefined"!=typeof b&&null!=b&&(lpPutGblPref("rememberemail",b?1:0),lpPutGblPref("rememberpassword",d?1:0));"undefined"!=typeof f&&lpPutGblPref("showvault",f?1:0);lpWriteAllPrefs()}yubikey_cleardata();googleauth_cleardata();outofband_cleardata();securityquestion_cleardata();sesame_cleardata();
grid_cleardata();e||multifactor_cleardata();a=fix_username(a);var p=get_key_iterations(a);g_local_key=g?g:make_lp_key_iterations(a,c,p);"string"==typeof c&&c.length&&calculateMasterStrength(a,c);g_local_hash=h?lphash=h:lphash=make_lp_hash_iterations(g_local_key,c,p);g_local_key_hex=AES.bin2hex(g_local_key);g_local_key_hash=SHA256(g_local_key);g_username=lpusername=a;g_username_hash=lpusername_hash=SHA256(g_username);g_retryusername=g_username;var q=SHA256(a);g=localStorage_getItem(q+"LPMPS");null==
g?(g=get_random(1E4,9999999).toString(36)+get_random(1E4,9999999).toString(36),k(g),protect_data(g,!0,null,function(a){localStorage_setItem(q+"LPMPS",a)})):unprotect_data(g,!0,k);lploggedinoffline||loginoffline(!0,"pluginlogin");var n="canexpire=1&cansetuuid=1&xml=2&username="+en(a)+"&method="+encodeURIComponent(get_method())+"&hash="+en(g_local_hash)+"&version="+lpversion,n=n+get_devicetype_param(),n=n+("&encrypted_username="+en(lpenc(g_username,null,!0)));console_log("login getting uuid");getuuid(function(b){console_log("login got uuid");
n+="&uuid="+en(b);n+="&lang="+en(lpGetPref("language",navigator.language));b=get_key_iterations(a);n+="&iterations="+en(b);""!=b&&1<parseInt(b)&&(b=checkNeedsPBKDF2v2(a,c),n+=b,""!=b&&("undefined"!=typeof g_oldpbkdf2&&1==g_oldpbkdf2)&&(n+="&fallback=1"));b=1==lpGetPref("logoffWhenCloseBrowser",0)&&0==lpGetPref("logoffWhenCloseBrowserVal",0)?"1":"0";n+="&sessonly="+en(b);sesame_cleardata();sesame_setdata("postdata",n);sesame_setdata("from","login");yubikey_cleardata();yubikey_setdata("postdata",n);
yubikey_setdata("from","login");g_iterpw=c;googleauth_cleardata();googleauth_setdata("postdata",n);googleauth_setdata("from","login");outofband_cleardata();outofband_setdata("postdata",n);outofband_setdata("from","login");securityquestion_cleardata();securityquestion_setdata("postdata",n);securityquestion_setdata("from","login");grid_cleardata();grid_setdata("postdata",n);grid_setdata("from","login");e||multifactor_cleardata();multifactor_setdata("postdata",n);multifactor_setdata("from","login");
n+="&otp=";n+="&sesameotp=";n+="&multifactorresponse=";GetOTPHash(n)},g_username_hash)}else make_lp_key_iterations(a,c,get_key_iterations(a),function(g){LP_do_login(a,c,b,d,e,f,g,h)})}
function loginoffline(a,c){console_log("server.js : loginoffline from="+c+" offline_before_online="+a);skiplogin()||(null==g_local_key||null==g_username||null==g_username_hash?"frompipes"!=c&&get_saved_logins(function(b){var d="",e="",f=function(b){if((!LPISLOC||!LPISUPEK)&&0<d.length&&0<b.length){g_username=lpusername=d.toLowerCase().replace(/\s*/g,"");g_username_hash=lpusername_hash=SHA256(d);var e=get_key_iterations(g_username);make_lp_key_iterations(g_username,b,e,function(d){g_local_key=d;g_local_hash=
lphash=make_lp_hash_iterations(g_local_key,b,e);g_local_key_hex=AES.bin2hex(g_local_key);g_local_key_hash=SHA256(g_local_key);loginoffline1(a,c)})}};if(0<b.length){d=b[0].username;e=b[0].password;if(1==b[0]["protected"]){unprotect_data(e,!1,f);return}if(2==b[0]["protected"]){f(lpdec(e,AES.hex2bin(SHA256(d))));return}f(e)}lpdbg("login","Trying to log in offline1: skipping because we dont have the user's key")}):loginoffline1(a,c))}
function read_key_from_file(a){have_binary_function("read_file")?call_binary_function("read_file",db_prepend(g_username_hash+"_lpall.slps"),function(c){"string"!=typeof c?a(""):unprotect_data(c,!0,a)}):a("")}
function read_accts_from_file(a){have_binary_function("read_file")?call_binary_function("read_file",db_prepend(g_username_hash+"_lps.act.sxml"),function(c){"string"!=typeof c?a(""):unprotect_data(c,!0,function(b){b=checkIterationsInDataFile(b);"iterationserror"==b?(lpdbg("login","Key iterations mismatch"),a("")):(b=lpdec(b),a(b))})}):a("")}
function loginoffline1(a,c,b){console_log("server.js : loginoffline1 offline_before_online="+a+" from="+c);if(a){if(!g_loggedinoffline){console_log("server.js : DB:opening database");var d=opendb();console_log("server.js : DB:opened database db="+d);createDataTable(d);if(d){console_log("server.js : DB:created database");var e=function(d,e){console_log("server.js : DB:inside transaction A");if(2!=e.rows.length)console_log("server.js : DB:inside transaction B"),LPISLOC&&(!LPISUPEK||b||""==g_username||
AES.hex2bin(SHA256(g_username+""))==g_local_key?lpshowError("LoginError",!1,!0):(g_pwdeckey=g_local_key,lpWriteKeyFile(),g_local_accts_version=0,LPISUPEK&&(g_prompts.login_site_prompt=!0,g_prompts.edit_site_prompt=!0,g_prompts.edit_sn_prompt=!0,g_prompts.view_pw_prompt=!0,g_prompts.view_ff_prompt=!0,g_prompts.switch_identity_prompt=!0,g_prompts.switch_f_prompt=!0,g_prompts.multifactor_reprompt=!0),rewritelocalfile(),loginoffline1(a,c,!0))),console_log("server.js : DB:inside transaction C"),lpdbg("login",
"Trying to log in offline : offline before online failed : could not read keyfile or accts");else{console_log("server.js : DB:inside transaction D");var f="key"==e.rows.item(0).type?0:1,g=e.rows.item(f).data,f=!1,g=g.split("\n");2==g.length&&"lastpass rocks"==lpdec(g[1],g_local_key)&&(console_log("server.js : DB:inside transaction E"),f=!0);f?(console_log("server.js : DB:inside transaction G"),f="accts"==e.rows.item(0).type?0:1,g=e.rows.item(f).data,g=g.substring(0,220),g=checkIterationsInDataFile(g),
"iterationserror"==g?lpdbg("login","Key iterations mismatch, bailing on loginoffline"):0<=g.indexOf("type=sesameoffline\ndata=")||0<=g.indexOf("type=yubikeyoffline\ndata=")||0<=g.indexOf("type=trueapioffline\ndata=")||0<=g.indexOf("type=omnikeyoffline\ndata=")?(console_log("server.js : DB:inside transaction H"),lpdbg("login","Data is encoded with multifactor key, bailing on loginoffline")):(console_log("server.js : DB:inside transaction I"),offlineloginsuccessful(c,!0),lpdbg("login","Trying to log in offline : offline before online successful"))):
(console_log("server.js : DB:inside transaction F"),LPISLOC&&lpshowError("LoginError",!1,!0),lpdbg("login","Trying to log in offline: skipping because we have an incorrect user's key"))}},f=function(){lpdbg("login","Trying to log in offline3: skipping because we dont have the user's key")};if(LPISLOC)read_key_from_file(function(a){read_accts_from_file(function(b){""!=a||""!=b?e(tx,{rows:{length:2,item:function(c){return 0==c?{type:"key",data:a}:{type:"accts",data:b}}}}):e(tx,{rows:{length:0}})})});
else if(g_indexeddb){var g={rows:{item:function(a){return this[a]},length:0}};d.transaction("LastPassData","readonly").objectStore("LastPassData").index("username_hash").openCursor(IDBKeyRange.only(db_prepend(g_username_hash))).onsuccess=function(a){if(a=a.target.result){if("key"==a.value.type||"accts"==a.value.type)g.rows[g.rows.length]=a.value,g.rows.length++;a["continue"]()}else e(null,g)}}else d.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND (type=? OR type=?)",
[db_prepend(g_username_hash),"key","accts"],e,f)})}else console_log("server.js : DB:failed to create database db="+d)}}else g_loggedinoffline||(d=opendb(),createDataTable(d),d&&(e=function(a,b){if(2!=b.rows.length)lpdbg("login","Trying to log in offline : offline before online failed : could not read keyfile or accts");else{var d="key"==b.rows.item(0).type?0:1,e=b.rows.item(d).data,d=!1,e=e.split("\n");2==e.length&&"lastpass rocks"==lpdec(e[1],g_local_key)&&(d=!0);d?(d="accts"==b.rows.item(0).type?
0:1,e=b.rows.item(d).data,e=e.substring(0,220),e=checkIterationsInDataFile(e),"iterationserror"==e?lpdbg("login","Trying to log in offline: skipping because we have a key iterations mismatch"):0<=e.indexOf("type=sesameoffline\ndata=")?(lpdbg("sesame","Logging in offline and existing file is protected by sesameoffline => asking user for offline password"),sesame_setdata("offline",1),sesame_getotp(null)):0<=e.indexOf("type=trueapioffline\ndata=")||0<=e.indexOf("type=omnikeyoffline\ndata=")?(lpdbg("multifactor",
"Logging in offline and existing file is protected by trueapioffline => asking user for offline password"),d=0<=e.indexOf("type=trueapioffline\ndata=")?"trueapi":"omnikey",multifactor_setdata("offline",1),multifactor_setdata("type",d),multifactor_getresponse(g_username)):0<=e.indexOf("type=yubikeyoffline\ndata=")?(yubikey_setdata("offline",1),yubikey_getotp(null)):(offlineloginsuccessful(c,!1),lpdbg("login","Trying to log in offline : offline after online successful"))):lpdbg("login","Trying to log in offline: skipping because we have an incorrect user's key")}},
LPISLOC?read_key_from_file(function(a){read_accts_from_file(function(b){""!=a||""!=b?e(tx,{rows:{length:2,item:function(c){return 0==c?{type:"key",data:a}:{type:"accts",data:b}}}}):e(tx,{rows:{length:0}})})}):g_indexeddb?(g={rows:{item:function(a){return this[a]},length:0}},d.transaction("LastPassData","readonly").objectStore("LastPassData").index("username_hash").openCursor(IDBKeyRange.only(db_prepend(g_username_hash))).onsuccess=function(a){if(a=a.target.result){if("key"==a.value.type||"accts"==
a.value.type)g.rows[g.rows.length]=a.value,g.rows.length++;a["continue"]()}else e(null,g)}):d.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND (type=? OR type=?)",[db_prepend(g_username_hash),"key","accts"],e)})))}
function offlineloginsuccessful(a,c){console_log("server.js : offlineloginsuccessful beforeonlineattempt="+c+" from="+a);if(LPISLOC&&("pluginlogin"==a&&g_manual_login)&&(1==lpGetPref("showvault",g_showvaultdefault)||g_showvaultalways))console_log("server.js : offlineloginsuccessful openvault offline version!"),openvault(1);console_log("server.js : offlineloginsuccessful!");g_loggedinonline||(g_loggedinoffline=!0);lploggedin=!0;lpReadAllPrefs(function(){drawIconAtRotation(0)});loggedIn("pluginlogin"==
a);console_log("RSA : offlineloginsuccessful : calling readrsaprivatekeyhexfromdb()");readrsaprivatekeyhexfromdb();"offline"!=a&&(console_log("server.js : offlineloginsuccessful : from "+a+" so calling get_accts_local!"),get_accts_local(!0));g_notifytimerid&&(clearTimeout(g_notifytimerid),g_notifytimerid=null);g_notifytimerid=setTimeout(function(){notifyoffline(a)},c?3E4:0);g_retryonlinetimerid&&(clearTimeout(g_retryonlinetimerid),g_retryonlinetimerid=null);g_retryonlinetimerid=setTimeout(function(){retryonlinelogin(3E4)},
3E4)}function notifyoffline(a){console_log("server.js : notifyoffline from="+a);lploggedin&&g_loggedinoffline&&(lpdbg("login","Trying to log in offline : notify user that they are logged in offline"),LPISLOC||lpshowError("LoggedInOffline",!1,!1,!1,null,!0))}
function retryonlinelogin(a){console_log("server.js : retryonlinelogin delayms="+a);if(lploggedin&&g_loggedinoffline){lpdbg("login","We're still logged in offline => retrying to login online.  retryinterval="+a/6E4+" minutes");lplogincheck("retryonline");var c=2*a;12E5<c&&(c=12E5);setTimeout(function(){retryonlinelogin(c)},c)}}function lpTurnOffIcon(){lploggedin=!1;set_badge_text("");drawIconAtRotation(0)}
function lpLoginCheckResponse(a,c,b){console_log("server.js : lpLoginCheckResponse fromwebsite="+b);try{if(a&&4==a.readyState&&"function"==typeof c&&(200!=a.status||null==a.responseXML||null==a.responseXML.documentElement))c();else{if(4==a.readyState&&200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement){var d=a.responseXML.documentElement.getElementsByTagName("ok");if(0<d.length){var e=d[0].getAttribute("lpusername");g_username=lpusername=e;g_username_hash=SHA256(g_username);if("retryonline"!=
b&&!0!=b){lpReadAllPrefs(function(){lpLoginCheckResponseStep2(a,e,b);drawIconAtRotation(0)});return}}}lpLoginResponse_win(a,b,!0)}}catch(f){L("logincheckresponse: "+f)}}
function lpLoginCheckResponseStep2(a,c,b){console_log("server.js : lpLoginCheckResponseStep2 fromwebsite="+b);try{var d=a.responseXML.documentElement.getElementsByTagName("ok");1==d[0].getAttribute("trustexpired")&&clearuuid(c);var e=d[0].hasAttribute("trustuuid")?d[0].getAttribute("trustuuid"):"";e&&""!=e&&setuuid(e,g_username_hash);lpdbg("login","lpLoginCheckResponseStep2");var f=null!=d[0].getAttribute("sesamepassword")&&""!=d[0].getAttribute("sesamepassword")?!0:!1,g=null!=d[0].getAttribute("yubikeyhash")&&
""!=d[0].getAttribute("yubikeyhash")?!0:!1,h=null!=d[0].getAttribute("googleauthenabled")&&"1"==d[0].getAttribute("googleauthenabled")?!0:!1,k=null!=d[0].getAttribute("gridenabled")&&""!=d[0].getAttribute("gridenabled")?!0:!1,j=null!=d[0].getAttribute("multifactorenabled")&&""!=d[0].getAttribute("multifactorenabled")?!0:!1,l=null!=d[0].getAttribute("sesameotpok")&&""!=d[0].getAttribute("sesameotpok")?!0:!1,p=null!=d[0].getAttribute("yubikeyotpok")&&""!=d[0].getAttribute("yubikeyotpok")?!0:!1,q=null!=
d[0].getAttribute("googleauthotpok")&&""!=d[0].getAttribute("googleauthotpok")?!0:!1,n=null!=d[0].getAttribute("gridresponseok")&&""!=d[0].getAttribute("gridresponseok")?!0:!1,x=null!=d[0].getAttribute("multifactorresponseok")&&""!=d[0].getAttribute("multifactorresponseok")?!0:!1,v=null!=d[0].getAttribute("disableoffline")&&1==d[0].getAttribute("disableoffline")?!0:!1;d[0].getAttribute("model")&&(g_lp_model=d[0].getAttribute("model"));console_log("server.js : ***** disableoffline="+v);if(!("websitelogin"==
b||"webrootwebsitelogin"==b||"websiterefresh"==b||"websiterefreshrsa"==b||"2ndfactorok"==b||"frompipes"==b)&&(null==g_local_key||""==g_local_key)&&1==lpGetPref("logoffWhenCloseBrowser",0)){var t=lpGetPref("lastpollcheck",0),r=pref_numeric_validate(lpGetPref("logoffWhenCloseBrowserVal",0),0),s=1E3*lp_get_gmt_timestamp()-t;console_log("server.js : "+t+" "+r+" "+s);if(s>=6E4*r){loggedOut(!1,"logoffWhenCloseBrowser lastpollcheck="+t+" logoffWhenCloseBrowserVal="+r+" timesincelastpollcheck="+s);if(1==
lpGetPref("openloginstart",LPISUPEK?1:0))g_reprompt_error_callback=g_reprompt_callback=null,open_login();return}}if("httptest"==b){if(f)if(l)b="2ndfactorok",lpdbg("login","LoginCheck : sesame reprompt-rerequest succeeded!");else{lpdbg("login","LoginCheck : Asking for sesame OTP and reissuing request to login_check.php");lpdbg("sesame","LOGIN CHECK RESPONSE: sesameenabled => Asking user for OTP and then reissuing the login_check request");sesame_setdata("fromwebsite",b);lpCheckForKey(function(){sesame_getotp(c,
d[0])});return}if(g)if(p)b="2ndfactorok",lpdbg("login","LoginCheck : yubikey reprompt-rerequest succeeded!");else{lpdbg("login","LoginCheck : Asking for yubikey OTP and reissuing request to login_check.php");lpdbg("yubikey","LOGIN CHECK RESPONSE: yubikeyenabled => Asking user for OTP and then reissuing the login_check request");yubikey_setdata("fromwebsite",b);lpCheckForKey(function(){yubikey_getotp(c,d[0])});return}if(h)if(q)b="2ndfactorok",lpdbg("login","LoginCheck : googleauth reprompt-rerequest succeeded!");
else{lpdbg("login","LoginCheck : Asking for googleauth OTP and reissuing request to login_check.php");lpdbg("googleauth","LOGIN CHECK RESPONSE: googleauthenabled => Asking user for OTP and then reissuing the login_check request");googleauth_setdata("fromwebsite",b);lpCheckForKey(function(){googleauth_getotp(c,d[0])});return}if(k)if(n)b="2ndfactorok",lpdbg("login","LoginCheck : grid reprompt-rerequest succeeded!");else{lpdbg("login","LoginCheck : Asking for grid response and reissuing request to login_check.php");
lpdbg("grid","LOGIN CHECK RESPONSE: gridenabled => Asking user for coordinates and then reissuing the login_check request");grid_setdata("fromwebsite",b);grid_setdata("wxsessid",d[0].getAttribute("wxsessid"));grid_getvalues(c,d[0].getAttribute("challenge"),d[0]);return}if(j)if(x)b="2ndfactorok",lpdbg("login","LoginCheck : multifactor reprompt-rerequest succeeded!"),"omnikey"==multifactor_getdata("type")&&multifactor_setdata("password_offline",d[0].getAttribute("multifactorofflinepassword"));else{lpdbg("login",
"LoginCheck : Asking for multifactor response and reissuing request to login_check.php");lpdbg("multifactor","LOGIN CHECK RESPONSE: multifactorenabled => Asking user for coordinates and then reissuing the login_check request");multifactor_setdata("fromwebsite",b);multifactor_setdata("wxsessid",d[0].getAttribute("wxsessid"));multifactor_setdata("type",d[0].getAttribute("type"));multifactor_getresponse(c,d[0].getAttribute("challenge"));return}}lpLoginResponse_win(a,b,!0)}catch(y){console_log(y.message)}}
function lpLoginResponse2(a,c,b){console_log("server.js : lpLoginResponse fromwebsite="+b);try{console_log("server.js : Got login response"),a&&4==a.readyState&&"function"==typeof c&&(200!=a.status||null==a.responseXML||null==a.responseXML.documentElement)?c():(console_log("server.js : Processing login response"),lpLoginResponse_win(a,b,!1))}catch(d){L("loginresponse: "+d)}}function lpLoginResponse(a,c,b){lpLoginResponse2(a,c,b)}
function lp_login_from_saved(){console_log("server.js : lp_login_from_saved");try{get_saved_logins(function(a){if(0<a.length){var b=a[0].username,d=a[0].password;if(""!=d){var e=function(a){if((!LPISLOC||!LPISUPEK)&&""!=a)console_log("server.js : Logging in from saved"),LP_do_login(b,a,!0,!0)};1==a[0]["protected"]?unprotect_data(d,!1,e):2==a[0]["protected"]&&e(lpdec(d,AES.hex2bin(SHA256(a[0].username))));return}}if(1==lpGetPref("openloginstart",LPISUPEK?1:0))g_reprompt_error_callback=g_reprompt_callback=
null,open_login()})}catch(a){console_log(a.message)}}function lpLoginCommon(a){console_log("server.js : lpLoginCommon bIsLoginCheck="+a);g_loggedinonline=!0;g_loggedinoffline=!1;g_notifytimerid&&(clearTimeout(g_notifytimerid),g_notifytimerid=null);g_retryonlinetimerid&&(clearTimeout(g_retryonlinetimerid),g_retryonlinetimerid=null)}var lploginerrorhandlercalled=0;
function lpLoginError(){console_log("server.js : lpLoginError");console_log("server.js : Got Login Error");var a=(new Date).getTime();1E3>a-lploginerrorhandlercalled||(lploginerrorhandlercalled=a,lpdbg("login","Login via login.php failed => try logging in offline using saved credentials -- if not already logged in offline --"),loginoffline(!1,"ErrorHandler"))}
function lpLoginCheckError(){console_log("server.js : lpLoginCheckError");lpdbg("login","Got lpLoginCheckError");g_loggedinoffline||(lpshowError("ErrorLoginMsg"),loggedOut(!1,"lpLoginCheckError"),lp_login_from_saved())}
function lpLoginResponse_win(a,c,b){console_log("server.js : lpLoginResponse_win fromwebsite="+c+" bIsLoginCheck="+b);if(a)if(4==a.readyState&&200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement){var d=a.responseXML.documentElement,e=d.getElementsByTagName("ok"),f=!1;lpdbg("login","lpLoginResponse_win");if(0<e.length){lpdbg("login","got login ok");(d=e[0].hasAttribute("trustuuid")?e[0].getAttribute("trustuuid"):"")&&""!=d&&setuuid(d,g_username_hash);server_tries=0;g_username=e[0].getAttribute("lpusername");
g_username_hash=SHA256(g_username);if(g_is_recovery_login)g_is_recovery_login=!1;else{if("1"==e[0].getAttribute("pwresetreqd")){d=g_username;b?openurlifnotopen(base_url+"passwordreset.php?u="+en(d)):openURL(base_url+"passwordreset.php?u="+en(d));loggedOut(!1,"pwresetreqd set");return}"0"!=e[0].getAttribute("pwresetreqd")&&""!=e[0].getAttribute("pwresetreqd")&&(d=g_username,f="&req="+en(e[0].getAttribute("pwresetreqd")),b?openurlifnotopen(base_url+"passwordreset.php?u="+en(d)+f):openURL(base_url+"passwordreset.php?u="+
en(d)+f))}if(e[0].getAttribute("iterations")){d=parseInt(e[0].getAttribute("iterations"));if(!checkIterationsReductionOk(d))return;localStorage_setItem(g_username_hash+"_key_iter",d)}g_iterpw="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";g_pwdeckey=AES.hex2bin(SHA256(e[0].getAttribute("pwdeckey")));g_uid=lpuid=e[0].getAttribute("uid");localStorage_setItem(g_username_hash+"LPMPD",g_uid);g_logoff_other_ses="1"==e[0].getAttribute("logoff_other_ses")?
!0:!1;g_generatedpw="1"==e[0].getAttribute("generatedpw")?!0:!1;countryfromip=e[0].getAttribute("country");g_lastpollcheck=g_lastpoll=lastlogin=(new Date).getTime();g_token=lptoken=e[0].getAttribute("token");d=e[0].getAttribute("noshare");f=e[0].getAttribute("noshareexceptfolders");g_sharing_enabled="1"!=d&&"1"!=f;g_folder_sharing_enabled="1"!=d;if(d=e[0].getAttribute("prefdata")){d=atob(d);f=[];parsemobile(d,d.length,100,0,null,[],null,null,null,null,null,null,!0,!1,null,null,null,null,null,null,
f,null,null,null,null,null,null,null,null,null,null,!1);for(var g in f)if(void 0===g_prefoverrides||g_prefoverrides[g]!==f[g]){g_prefoverrides=f;rewritelocalfile();break}}if((g=e[0].getAttribute("pollinterval"))&&-1!=g&&!isNaN(parseInt(g))&&isFinite(g))lpPutUserPref("pollServerVal",g),lpWriteAllPrefs(),g_flags.pollIntervalSetByPolicy=1;getsinglefactortype(function(a){"1"==e[0].getAttribute("multifactor_singlefactor")?(""==a&&("trueapi"==multifactor_getdata("type")?have_binary_function("trueapi_default_login_exists")&&
call_binary_function("trueapi_default_login_exists",g_username,function(a){a&&setsinglefactortype(multifactor_getdata("type"))}):"vtapi"==e[0].getAttribute("singlefactortype")?have_binary_function("lpvt_has_data")&&call_binary_function("lpvt_has_data",function(a){a&&setsinglefactortype(e[0].getAttribute("singlefactortype"))}):"validity"==e[0].getAttribute("singlefactortype")?have_binary_function("validity_has_data")&&call_binary_function("validity_has_data",function(a){a&&setsinglefactortype(e[0].getAttribute("singlefactortype"))}):
"winbio"==e[0].getAttribute("singlefactortype")?have_binary_function("winbio_has_data")&&call_binary_function("winbio_has_data",function(a){a&&setsinglefactortype(e[0].getAttribute("singlefactortype"))}):"nymi"==e[0].getAttribute("singlefactortype")&&have_binary_function("nymi_has_data")&&call_binary_function("nymi_has_data",function(a){a&&setsinglefactortype(e[0].getAttribute("singlefactortype"))})),"nymi"==e[0].getAttribute("singlefactortype")&&have_binary_function("nymi_get_version")&&call_binary_function("nymi_get_version",
function(a){parseInt(e[0].getAttribute("nymi_version"))>a&&lpMakeRequest(base_url+"nymi_data.php","token="+en(e[0].getAttribute("token"))+"&action=read&b64=1",function(a){4==a.readyState&&(200==a.status&&a.responseXML&&a.responseXML.documentElement)&&(a=a.responseXML.documentElement.getElementsByTagName("ok"),0<a.length&&(call_binary_function("nymi_write_data",lpatob(a[0].getAttribute("data"))),setsinglefactortype("nymi")))})})):""!=a&&disable_single_factor()});sesame_setdata("password_offline",e[0].getAttribute("sesamepassword"));
yubikey_setdata("password_offline",e[0].getAttribute("yubikeyhash"));if((g=e[0].getAttribute("note_title"))&&g.length)d=e[0].getAttribute("note_text"),f=e[0].hasAttribute("note_url")?e[0].getAttribute("note_url"):null,handlenotifications(g,d,f);lpLoginResponse_win1_5(a,c,b);lpLoginCommon(b);if(lpdisableoffline=1==e[0].getAttribute("disableoffline")?1:0)lpdbg("disableoffline","server.js : enabled => clearing sensitive files"),clearCache(!0,!1,!1,!0);e[0].getAttribute("model")&&(g_lp_model=e[0].getAttribute("model"));
if(g_manual_login&&(1==lpGetPref("showvault",g_showvaultdefault)||g_showvaultalways))console_log("openvault from login okay"),openvault(1);setTimeout(function(){checkAttach()},1E4)}else{console_log(a.responseText);b=d.getElementsByTagName("error");if(0<b.length){lpdbg("login","got login error");1==b[0].getAttribute("trustexpired")&&clearuuid(g_username);if(b[0].getAttribute("iterations")){d=parseInt(b[0].getAttribute("iterations"));checkIterationsReductionOk(d)&&(localStorage_setItem(SHA256(g_username)+
"_key_iter",d)||(DEFAULT_KEY_ITERATIONS=d),LP_do_login(g_username,g_iterpw));return}if(b[0].getAttribute("pbkdf2fallback")&&("undefined"==typeof g_oldpbkdf2||1!=g_oldpbkdf2)){g_oldpbkdf2=1;yubikey_getdata("p");LP_do_login(g_username,g_iterpw);return}"undefined"!=typeof g_oldpbkdf2&&(g_oldpbkdf2=0);if(b[0].getAttribute("server")){a=b[0].getAttribute("server");if("lastpass.com"==a||"lastpass.eu"==a)base_url="https://"+a+"/",lpPutGblPref("server",a),LP_do_login(g_username,g_iterpw);return}b[0].getAttribute("openurl")&&
(g=b[0].getAttribute("openurl"),openURL(g));if(b[0].hasAttribute("invalidsession")){openURL(base_url+"invalidsession.php");lpshowError(0<b.length&&b[0].getAttribute("message")?b[0].getAttribute("message"):"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"invalidsession");return}f=1==parseInt(b[0].getAttribute("silent"));allowmultifactortrust=!0;0<a.responseText.indexOf("allowmultifactortrust=")&&(allowtrust_str=a.responseXML.childNodes[0].childNodes[0].getAttribute("allowmultifactortrust"),allowmultifactortrust=
"false"==allowtrust_str?!1:!0);hidemultifactordisable=!1;0<a.responseText.indexOf("hidedisable=")&&(hidedisable_str=a.responseXML.childNodes[0].childNodes[0].getAttribute("hidedisable"),hidemultifactordisable="false"==hidedisable_str?!1:!0);if(0<a.responseText.indexOf("sesameotprequired")){lpdbg("sesame","LOGIN RESPONSE: sesameenabled => Asking user for OTP and then reissuing the login request");clearCache(!0,!1,!1);sesame_setdata("fromwebsite",c);sesame_getotp(g_username,b[0]);return}if(0<a.responseText.indexOf("sesameotpfailed")){lpshowError(0<
b.length&&b[0].getAttribute("message")?b[0].getAttribute("message"):"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"sesameotpfailed");return}if(0<a.responseText.indexOf("otprequired")){lpdbg("yubikey","LOGIN RESPONSE: yubikeyenabled => Asking user for OTP and then reissuing the login request");clearCache(!0,!1,!1);yubikey_setdata("fromwebsite",c);yubikey_getotp(g_username,b[0]);return}if(0<a.responseText.indexOf("otpfailed")){lpshowError(0<b.length&&b[0].getAttribute("message")?b[0].getAttribute("message"):
"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"otpfailed");return}g=!1;if(0<a.responseText.indexOf("googleauthfailed"))if(g=googleauth_getdata("fail_count"),null==g&&(g=0),g++,googleauth_setdata("fail_count",g),5>g)g=!0;else{googleauth_setdata("fail_count",0);lpshowError(0<b.length&&b[0].getAttribute("message")?b[0].getAttribute("message"):"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"otpfailed");return}var h=!1;if(0<a.responseText.indexOf("securityquestionfailed"))if(h=securityquestion_getdata("fail_count"),
null==h&&(h=0),h++,securityquestion_setdata("fail_count",h),5>h)0<b.length&&b[0].getAttribute("message")&&alert(b[0].getAttribute("message")),h=!0;else{securityquestion_setdata("fail_count",0);lpshowError(0<b.length&&b[0].getAttribute("message")?b[0].getAttribute("message"):"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"otpfailed");return}if(0<a.responseText.indexOf("googleauthrequired")||g){lpdbg("googleauth","LOGIN RESPONSE: googleauthenabled => Asking user for OTP and then reissuing the login request");
clearCache(!0,!1,!1);googleauth_setdata("fromwebsite",c);googleauth_getotp(g_username,b[0]);return}if(0<a.responseText.indexOf("outofbandrequired")){lpdbg("outofband","LOGIN RESPONSE: outofbandenabled => Asking user for OTP and then reissuing the login request");clearCache(!0,!1,!1);outofband_setdata("fromwebsite",c);outofband_getotp(g_username,b[0]);return}if(0<a.responseText.indexOf("securityquestionrequired")||h){lpdbg("securityquestion","LOGIN RESPONSE: securityquestionenabled => Asking user for answer and then reissuing the login request");
clearCache(!0,!1,!1);securityquestion_setdata("fromwebsite",c);securityquestion_getotp(g_username,b[0]);return}if(0<a.responseText.indexOf("gridresponserequired")){lpdbg("grid","LOGIN RESPONSE: gridenabled => Asking user for grid response and then reissuing the login request");clearCache(!0,!1,!1);grid_setdata("fromwebsite",c);grid_setdata("wxsessid",b[0].getAttribute("wxsessid"));grid_getvalues(g_username,b[0].getAttribute("challenge"),b[0]);return}if(0<a.responseText.indexOf("gridresponsefailed")){lpshowError(0<
b.length&&b[0].getAttribute("message")?b[0].getAttribute("message"):"LoginError",!1,!0);clearCache(!0,!1,!1);loggedOut(!1,"gridresponsefailed");return}if(0<a.responseText.indexOf("multifactorresponserequired")){lpdbg("multifactor","LOGIN RESPONSE: multifactorenabled => Asking user for multifactor response and then reissuing the login request");clearCache(!0,!1,!1);multifactor_setdata("fromwebsite",c);multifactor_setdata("wxsessid",b[0].getAttribute("wxsessid"));multifactor_setdata("type",b[0].getAttribute("type"));
multifactor_getresponse(g_username,b[0].getAttribute("challenge"));return}if(0<a.responseText.indexOf("multifactorresponsefailed")){a=(b=d.getElementsByTagName("error"))&&0<b.length&&b[0].getAttribute("type")?b[0].getAttribute("type"):multifactor_getdata("type");lpshowError(0<b.length&&b[0].getAttribute("message")?b[0].getAttribute("message"):"LoginError",!1,!0,!1,get_multifactor_disable_url(g_username,a));clearCache(!0,!1,!1);loggedOut(!1,"multifactorresponsefailed");return}}g_trial_available=1==
b[0].getAttribute("trialavailable");1==b[0].getAttribute("trialavailable")?lpTurnOffIcon():loggedOut(f,"lpLoginResponse_win A");f?lp_login_from_saved():0<a.responseText.indexOf("blacklist")?(clearCache(!0,!1,!1),lpshowError(0<b.length&&b[0].getAttribute("message")?b[0].getAttribute("message"):"Blacklist",!1,!0,!1,null,!1,b[0].getAttribute("custombutton"),b[0].getAttribute("customaction"))):(a=0<b.length&&b[0].getAttribute("cause")&&"unknownemail"==b[0].getAttribute("cause"),try_alternativeServer()?
LP_do_login(g_retryusername,g_iterpw):lpshowError(0<b.length&&b[0].getAttribute("message")?b[0].getAttribute("message"):"LoginError",!1,!0,a,null,!1,b[0].getAttribute("custombutton"),b[0].getAttribute("customaction"),1==b[0].getAttribute("trialavailable")?!0:!1))}}else loggedOut(!1,"lpLoginResponse_win B"),lpshowError("ErrorLoginMsg")}var server_tries=0;
function try_alternativeServer(){if("undefined"!=typeof g_disable_alternative_server&&g_disable_alternative_server||"https://lastpass.com/"==original_base||"https://lastpass.eu/"==original_base)return!1;server_tries++;base_url=3==server_tries||"https://lastpass.com/"==base_url||"https://lastpass.eu/"==base_url?original_base:"https://lastpass.com/";lpPutGblPref("server",base_url.substr(8,base_url.length-1));return 3==server_tries?(server_tries=0,!1):!0}
function disable_single_factor(){getsinglefactortype(function(a){"trueapi"==a&&have_binary_function("trueapi_delete_default_login")&&call_binary_function("trueapi_delete_default_login");setsinglefactortype("")})}
function lpLoginResponse_win1_5(a,c,b){console_log("server.js : lpLoginResponse_win1_5 fromwebsite="+c+" bIsLoginCheck="+b);a.responseXML.documentElement.getElementsByTagName("ok");null==g_local_key||""==g_local_key?!("websitelogin"==c||"webrootwebsitelogin"==c||"websiterefresh"==c||"websiterefreshrsa"==c||"2ndfactorok"==c||"frompipes"==c)&&1==lpGetPref("logoffWhenCloseBrowser",0)?lpReadAllPrefs(function(){lpLoginResponse_win1_75(a,c,b);drawIconAtRotation(0)}):lpReadKeyFile(a,c,!1,b):(lpWriteKeyFile(),
lpReadAllPrefs(function(){lpLoginResponse_win2(a,c,b);drawIconAtRotation(0)}))}function lpLoginResponse_win1_75(a,c,b){console_log("server.js : lpLoginResponse_win1_75 fromwebsite="+c+" bIsLoginCheck="+b);var d=lpGetPref("lastpollcheck",0),e=pref_numeric_validate(lpGetPref("logoffWhenCloseBrowserVal",0),0),f=1E3*lp_get_gmt_timestamp()-d;f>=6E4*e?loggedOut(!1,"lpLoginResponse_win1_75 lastpollcheck="+d+" logoffWhenCloseBrowserVal="+e+" timesincelastpollcheck="+f):lpReadKeyFile(a,c,!1,b)}
function lpLoginResponse_win2(a,c,b){console_log("server.js : lpLoginResponse_win2 fromwebsite="+c+" bIsLoginCheck="+b);var d=a.responseXML.documentElement,d=d.getElementsByTagName("ok");closeallnotifications(!0,!0);lp_phpsessid=d[0].getAttribute("sessionid");loggedIn();g_server_accts_version=parseInt(d[0].getAttribute("accts_version"));lp_server_attach_version=parseInt(d[0].getAttribute("attachversion"));console_log("server.js : lpLoginResponse_win2 lp_server_attach_version="+lp_server_attach_version);
g_server_accts_version!=g_local_accts_version&&(g_local_accts_version=-1);g_loglogins=parseInt(d[0].getAttribute("loglogins"));g_isadmin=1==parseInt(d[0].getAttribute("isadmin"));g_iscompanyadmin=1==parseInt(d[0].getAttribute("companyadmin"));g_showcredmon=1==parseInt(d[0].getAttribute("showcredmon"));iconsversion=parseInt(d[0].getAttribute("iconsversion"));g_multifactorscore=parseInt(d[0].getAttribute("multifactorscore"));g_disablepwalerts=1==parseInt(d[0].getAttribute("disablepwalerts"));lpsendchallengescore=
null!=d[0].getAttribute("sendchallengescore")&&1==d[0].getAttribute("sendchallengescore")?!0:!1;pwndlistscan=null!=d[0].getAttribute("pwndlistscan")&&1==d[0].getAttribute("pwndlistscan")?!0:!1;loglogin_url=null!=d[0].getAttribute("logloginsvr")?"https://"+d[0].getAttribute("logloginsvr")+"/":base_url;pollserver_url=null!=d[0].getAttribute("pollserver")?"https://"+d[0].getAttribute("pollserver")+"/":base_url;var e=d[0].getAttribute("pushserver");null!=e&&e.length&&setup_push_listener(e);lpCheckDownloadNewDataFile(d[0].getAttribute("formfillver"),
"ff.dat",ffver,"ff","ff.dat");lpCheckDownloadNewDataFile(d[0].getAttribute("sitesver"),"sites.dat",-1,"sites","sites.dat");lpCheckDownloadNewDataFile(d[0].getAttribute("bigicon"),"bigicons.dat",-1,"bigicon","bigicons.dat");""==d[0].getAttribute("privatekeyenchash")?(console_log("RSA : login response : server returned blank privatekeyenchash : calling generateSharingKeys()"),generateSharingKeys()):(console_log("RSA : login response : server returned privatekeyenchash : calling readrsaprivatekeyhexfromdb() to make sure it matches the local value"),
readrsaprivatekeyhexfromdb(!1,!0,d[0].getAttribute("privatekeyenchash")));(!b||"boolean"==typeof c&&c)&&lpnp_send_internal_logincheck_ack();d=a.responseXML.documentElement;d=d.getElementsByTagName("ok");1==lpGetPref("storeLostOTP",1)&&(d[0].hasAttribute("lostpwotpresult")&&"ok"!=d[0].getAttribute("lostpwotpresult")&&!1==g_norecovery)&&(DeleteOTP(),MakeOTP());if(!hassites()||g_server_accts_version!=g_local_accts_version)console_log("server.js : !hassites() or server_ver:"+g_server_accts_version+" != local_ver:"+
g_local_accts_version+" so calling get_accts_local!"),get_accts_local();checkIconsVersion(iconsversion);checkBigIconsVersion(null,!1,!0);lpretryrequests();if(d[0].getAttribute("sauid0")){a=0;for(c="";d[0].getAttribute("sauid"+a);)(b=lprsa_encryptdata(d[0].getAttribute("sakey"+a),AES.bin2hex(g_local_key)))&&(c+="&sauid"+a+"="+en(d[0].getAttribute("sauid"+a))+"&sakey"+a+"="+en(b)),a++;c.length&&lpMakeRequest(base_url+"uploadsuperkeys.php","cmd=uploadsuperadmin&"+c,null,null)}}
generateSharingKeys=function(){var a=!1;return function(c){console_log("RSA : generateSharingKeys : generating="+a);if(!a)if(have_binary_function("xGenerateKeys")){console_log("RSA : generateSharingKeys : using xGenerateKeys");a=!0;var b=AES.bin2hex(g_local_key).toUpperCase();call_binary_function("xGenerateKeys",b,function(a){console_log("RSA : generateSharingKeys : xGenerateKeys completed");a=a.split("|");2==a.length?(console_log("RSA : generateSharingKeys : xGenerateKeys was successful -- calling upload_rsa_keys()"),
upload_rsa_keys("xGenerateKeys",{privatekey:atob(a[0]),publickey:atob(a[1])})):console_log("RSA : generateSharingKeys : xGenerateKeys failed")})}else have_pplastpass()?(a=!0,b=AES.bin2hex(g_local_key).toUpperCase(),console_log("RSA : generateSharingKeys : using xGenerateKeys via pplastpass"),pplastpass_send_message({cmd:"xGenerateKeys",userkeyhex:b},function(a){console_log("RSA : generateSharingKeys : xGenerateKeys via pplastpass completed");a=a.split("|");2==a.length?(console_log("RSA : generateSharingKeys : xGenerateKeys via pplastpass was successful -- calling upload_rsa_keys()"),
upload_rsa_keys("xGenerateKeys",{privatekey:atob(a[0]),publickey:atob(a[1])})):console_log("RSA : generateSharingKeys : xGenerateKeys via pplastpass failed")})):g_ischrome?(console_log("RSA : generateSharingKeys : using Javascript RSAKey() to create sharing keys"),a=!0,b=new RSAKey,generate_key(b,function(a){console_log("RSA : generateSharingKeys : Javascript RSAKey() was successful -- calling upload_rsa_keys()");upload_rsa_keys("RSAKey",a)})):console_log("RSA : generateSharingKeys : Not generating keys since unsupported OS");
c&&c(a)}}();function lpCheckDownloadNewDataFile(a,c,b,d,e){if(!(""==a||0==a)){var f=b;c=localStorage_getItem(e);b=!1;null!=c&&""!=c&&"\n"!=c?(f=-1==c.indexOf("\n")?c.length:c.indexOf("\n"),f=c.substr(0,f)):b=!0;null!=f&&(""!=f&&-1!=f&&0<CompareLastPassVersions(a,f))&&(b=!0);b&&lpMakeRequest(base_url+"getappdata.php","type="+en(d),lpDownloadDataResponse,null,e)}}var adminoverride="",lplastgetaccounts=0;
function get_accts(){var a=(new Date).getTime();1E3>a-lplastgetaccounts||(lplastgetaccounts=a,a=base_url+"getaccts.php?mobile=1&b64=1&shap=1&u="+g_username_hash,a+="&includesharedfolderformfillprofiles=1&includeemergencyaccess=1",""!=adminoverride&&(a+="&adminoverride="+en(adminoverride)),lpMakeRequest(a,"",lpAcctsResponse,lpAcctsError))}function get_accts_local(a,c){lpReadAcctsData(a,c)}
function lpAcctsResponse(a){if(a&&4==a.readyState){var c=atob(a.responseText);write_history({cmd:"get_accts_success",sz:c.length,ready_state:a.readyState,status:a.status,lver:g_local_accts_version,sver:g_server_accts_version});lp_enterpriseuser=lp_premium_exp=0;a=get_ff_translation("ff_captcha_regexp");lp_captcha_regexp=""!=a?RegExp(a,"i"):null;g_emer_sharers=[];g_emer_sharees=[];g_totp={};parsemobile(c,c.length,100,0,postacctsload,[],[],[],[],[],[],[],!0,!1,null,[],[],[],[],[],[],lp_rsaprivatekeyhex,
[],null,null,null,[],[],[],[],void 0,void 0,g_emer_sharers,g_emer_sharees,g_totp);g_premium_exp=lp_premium_exp;g_enterpriseuser=lp_enterpriseuser}else write_history({cmd:"get_accts_fail",sz:a&&"string"==typeof a.responseXML?a.responseXML.length:-1,ready_state:a?a.readyState:-1,status:a?a.status:-1,lver:g_local_accts_version,sver:-1})}
function get_ff_translation(a){var c=lpGetPref("language","");""==c&&(c=navigator.language);var b=c,c=c.replace("-","_");if("es_419"==c||"es_419"==b||"es-419"==b||"es_xl"==c||"es_xl"==b||"es-xl"==b)c="es_MX",b="es-MX";"undefined"==typeof translations[c]&&"undefined"==typeof translations[b]&&(b=c=c.substring(0,2));if("undefined"==typeof translations[c]&&"undefined"==typeof translations[b])for(var d in translations)if(d.substring(0,2)==c){b=c=d;break}"undefined"==typeof translations[c]&&"undefined"==
typeof translations[b]&&(c="en_US",b="en-US");if("undefined"==typeof translations[c]&&"undefined"==typeof translations[b])for(d in b=c="en",translations)if(d.substring(0,2)==c){b=c=d;break}return"undefined"!=typeof translations[c]&&"undefined"!=typeof translations[c][a]&&""!=translations[c][a]?translations[c][a]:"undefined"!=typeof translations[b]&&"undefined"!=typeof translations[b][a]&&""!=translations[b][a]?translations[b][a]:"undefined"!=typeof translations.en_US&&"undefined"!=typeof translations.en_US[a]&&
""!=translations.en_US[a]?translations.en_US[a]:"undefined"!=typeof translations["en-US"]&&"undefined"!=typeof translations["en-US"][a]&&""!=translations["en-US"][a]?translations["en-US"][a]:""}
function rewritelocalfile(a,c,b){b="undefined"==typeof b?null:b;var d=flattendata(g_local_accts_version,g_sites,g_securenotes,g_prompts,g_formfills,g_identities,g_equivalentdomains,g_neverurls,g_premium_exp,lpenc(g_username),g_pendings,g_shareeautopushes,lpmaxid,g_urlrules,g_prefoverrides,g_shares,g_applications,g_enterpriseuser,lp_attaches,g_emer_sharers,g_emer_sharees,g_totp),d=btoa(d);if(LPISLOC||b)d="LPB64"+d;d=prependOTPAndEncrypt(d);d=prependIterations(d);lpSaveData(d,"accts");if(LPISLOC||b)if(d=
lpenc(d),d=prependIterations(d),!b&&!lpdisableoffline)protect_data(d,!0,null,function(d){if(have_binary_function("write_file")){var f="";a&&(f="_"+(new Date).toString().replace(" ","_"));f=db_prepend(g_username_hash+f+"_lps.act.sxml");b&&(f="lpexport.xml");call_binary_function("write_file",f,d)}!a&&!c&&lpnp_notify("refresh_local",{data0:g_username_hash})});else return d;update_menus(!0)}
function prependOTPAndEncrypt(a){var c=null,b="";sesame_getdata("password_offline")&&""!=sesame_getdata("password_offline")?(lpdbg("sesame","encrypting accounts file before writing"),c=sesame_getdata("password_offline"),b="type=sesameoffline\ndata="):multifactor_getdata("password_offline")&&""!=multifactor_getdata("password_offline")?(lpdbg("multifactor","encrypting accounts file before writing"),c=multifactor_getdata("password_offline"),b="type="+multifactor_getdata("type")+"offline\ndata="):yubikey_getdata("password_offline")&&
""!=yubikey_getdata("password_offline")&&(lpdbg("yubikey","encrypting accounts file before writing"),c=yubikey_getdata("password_offline"),b="type=yubikeyoffline\ndata=");if(c){a=enc(a,hex2bin(c));if(!a||""==a)return lpdbg("error","Failed to encrypt data in save_accounts_fileraw"),!1;a=b+a}return a}
function clearSavedPassword(a){var c=opendb();createSavedLoginsTable(c);c&&(console_log("server.js : clearing saved credentials"),g_indexeddb?c.transaction("LastPassSavedLogins2","readonly").objectStore("LastPassSavedLogins2").openCursor(IDBKeyRange.only(a)).onsuccess=function(a){a.target.result&&""!=a.target.result.value.password&&(a.target.result.value.password="",c.transaction("LastPassSavedLogins2","readwrite").objectStore("LastPassSavedLogins2").put(a.target.result.value))}:c.transaction(function(b){b.executeSql("UPDATE LastPassSavedLogins2 SET password = '' WHERE username = ?",
[a])}))}function checkforknownhackedsites(){}
function postacctsload(a,c,b,d,e,f,g,h,k,j,l,p,q,n,x,v,t,r,s,y,w,z){if(lploggedin)if(!h&&(!j||j&&0==a.length))console_log("server.js : ERROR: Could not parse accts data!!!"),gPulledInvalidAccts?lpshowError("ErrorGetAcctsMsg"):(gPulledInvalidAccts=!0,get_accts());else{try{if(null!=lp_trueapi_trial_exp){var A=parseInt(lp_trueapi_trial_exp);0<A&&A<parseInt((new Date).getTime()/1E3)&&(getsinglefactortype(function(a){"trueapi"==a&&setsinglefactortype("")}),"trueapi"==multifactor_getdata("type")&&multifactor_setdata("type",
""))}}catch(B){}if(0<a.length&&("undefined"!=typeof l&&null!=l&&""==adminoverride)&&(h=lpdec(l),""!=l&&null!=l&&"null"!=l&&g_username!=h))return lpReportError("Encrypted username check failed: "+g_username+" vs "+h+" for "+l+" local "+j,null),lpshowError("A consistency check failed while loading your sites. Please relogin."),clearSavedPassword(g_username),clearAllData(),loggedOut(!1,"encryptedusername_check_failed"),!1;lpmaxid=n.maxid;j||(l=btoa(k),l=prependOTPAndEncrypt(l),l=prependIterations(l),
lpSaveData(l,"accts"));l={};g_tlds=[];n=AES.bin2hex(g_local_key);for(var m=0;m<a.length;m++){a[m].url=AES.hex2url(a[m].url);a[m].tld=lp_gettld_url(a[m].url);if(LPISLOC&&a[m].tld)try{var u=function(){rfdefaults&&"undefined"!=typeof rfdefaults[a[m].tld]&&(a[m].submit_id=rfdefaults[a[m].tld].submit_id,a[m].captcha_id=rfdefaults[a[m].tld].captcha_id,a[m].custom_js=rfdefaults[a[m].tld].custom_js)};rfdefaults?u():lpReadFile("rfdefaults",function(a){rfdefaults=JSON.parse(lp_hex2bin(a));u()})}catch(C){}h=
"undefined"==typeof a[m].sharefolderid?g_local_key:getsharekey(r,a[m].sharefolderid);null!=h&&(v="undefined"==typeof a[m].sharefolderid?n:AES.bin2hex(h),a[m].unencryptedUsername=lpmdec(a[m].username,!0,h,v));"undefined"==typeof g_tlds[a[m].tld]&&(g_tlds[a[m].tld]=[]);g_tlds[a[m].tld][a[m].aid]=!0;l[a[m].aid]=a[m]}n={};for(m=0;m<c.length;m++)c[m].url=AES.hex2url(c[m].url),n[c[m].aid]=c[m];h={};for(m=0;m<s.length;m++)s[m].appname=AES.hex2url(s[m].appname),h[s[m].appaid]=s[m];g_sites=l;g_securenotes=
n;g_applications=h;g_prompts=b;g_formfills=d;g_identities=e;g_equivalentdomains=f;g_urlrules=x;g_neverurls=g;g_pendings=p;g_prefoverrides=t;g_shares=r;lp_attaches=y;0<g_shares.length&&(("undefined"==typeof lp_rsaprivatekeyhex||null==lp_rsaprivatekeyhex||""==lp_rsaprivatekeyhex)&&"undefined"==typeof g_keyloopprotection)&&setTimeout(function(){lp_rsaprivatekeyhex&&""!=lp_rsaprivatekeyhex?(g_keyloopprotection=!0,get_accts_local()):(g_keyloopprotection=!0,console_log("RSA : post accounts load : calling readrsaprivatekeyhexfromdb()"),
readrsaprivatekeyhexfromdb(!0,!0,null,function(){lp_rsaprivatekeyhex&&""!=lp_rsaprivatekeyhex&&get_accts()}))},5E3);overrideprefs(g_prefoverrides);setcachedffdat();g_shareeautopushes=[];parseAutoPushMobile(q,g_shareeautopushes);for(m=0;m<g_formfills.length;m++)g_formfills[m].decprofilename=lpmdec_acct(g_formfills[m].profilename,!0,g_formfills[m],g_shares);g_formfills.sort(function(a,b){return a.decprofilename.toLowerCase()<b.decprofilename.toLowerCase()?-1:1});if("undefined"==typeof g_identity||null==
g_identity)g_identity="";b=!1;for(m=0;m<g_identities.length;m++)g_identities[m].deciname=lpdec(g_identities[m].iname),g_identities[m].iid==g_identity&&(b=!0);g_identities.sort(function(a,b){return a.deciname.toLowerCase()<b.deciname.toLowerCase()?-1:1});if(!b&&""!=g_identity)return identityFilter="",switch_identity("",!0),clearCache(!0,!1,!1),setTimeout(function(){loggedOut(!1,"wrongidentity")},500),console_log("Identity: "+g_identity),alertfrombg(gs("Your selected Identity no longer exists. Defaulting to 'All' and logging off.")),
!1;rsa_acceptpendingshares();rsa_acceptshareeautopushes();u=function(a){a=(null==a?"":a).split("\n");for(var b=0;b<a.length;b++){var c=a[b].split(" ");if(2==c.length&&""!=c[0]&&""!=c[1]){var d=c[0],c=c[1];g_sites[d]&&c>g_sites[d].last_touch&&(g_sites[d].last_touch=c)}}};b="";(g_is_win||g_is_mac&&LPISLOC)&&have_binary_function("read_file")?call_binary_function("read_file",db_prepend(g_username_hash+"_lt.cac"),u):("undefined"!=typeof localStorage&&(b=localStorage_getItem(db_prepend(g_username_hash+
"_lt.cac"))),u(b));if("undefined"!=typeof foundmsfi&&!1==j){postdata="";j=0;for(m in msfids){f=msfids[m].shareid;e="";b=null;for(d=0;d<g_shares.length;d++)if(g_shares[d].id==f){e=AES.bin2hex(g_shares[d].key);b=g_shares[d].decsharename;break}null!==b&&(f=new RSAKey,parse_public_key(f,msfids[m].key)&&(e=f.encrypt(e),d=lpenc(b,g_shares[d].key),postdata+="&sharekey"+j+"="+encodeURIComponent(e)+"&uid"+j+"="+encodeURIComponent(msfids[m].uid),postdata+="&shareid"+j+"="+encodeURIComponent(msfids[m].shareid),
postdata+="&decsharename"+j+"="+encodeURIComponent(b),postdata+="&encsharename"+j+"="+encodeURIComponent(d),j++))}j=0;lpMakeRequest(base_url+"process_msf.php",postdata,null,null)}console_log("server.js : num sites: "+a.length+" num sn: "+c.length+" num ff: "+g_formfills.length+" num identities: "+g_identities.length+" pendings: "+g_pendings.length+" num applications: "+g_applications.length);recheckall();update_menus(!0);"undefined"!=typeof w&&w.attachversion>lp_server_attach_version&&(console.log("setting lp_server_attach_version="+
w.attachversion),lp_server_attach_version=w.attachversion);g_runchallenge?setTimeout(function(){runChallenge()},1E4):fix_sites_secure_reprompt();"undefined"!=typeof z&&"function"==typeof handle_pending_pushed_sites&&handle_pending_pushed_sites(z,function(){get_accts()},g_shares);checkBigIconsVersion();checkforknownhackedsites();if("undefined"!=typeof share_folder_group&&""!=share_folder_group&&"undefined"!=typeof share_folder_id&&""!=share_folder_id)for(m=0;m<r.length;m++)if(r[m].id==share_folder_id){c=
share_folder_group;set_share_folder_group("");set_share_folder_id("");renameGroup(c,r[m].decsharename);break}g_local_accts_version=get_version(k)}}function setcachedffdat(){for(var a=localStorage_getItem("ff.dat"),a=null==a?translations:LPJSON.parse(a),c=[],b=0;b<g_formfills.length;b++)c[lpmdec_acct(g_formfills[b].profilelanguage,!0,g_formfills[b],g_shares)]=1;var d=[];for(b in a)if("en-US"==b||"undefined"!=typeof c[b])d[b]=a[b];g_cachedffdat=LPJSON.stringify(d)}
function overrideprefs(a){"undefined"!=typeof a.allowmasterpasswordsave&&"0"==a.allowmasterpasswordsave?(lpPutGblPref("rememberpassword",0),g_master_password_saved=!1,deletesavedpw(),localStorage_setItem(g_username_hash+".noremember",1)):localStorage_removeItem(g_username_hash+".noremember");"undefined"!=typeof a.logoffclosebrowser&&"-1"!=a.logoffclosebrowser&&(lpPutGblPref("logoffWhenCloseBrowser",1),lpPutGblPref("logoffWhenCloseBrowserVal",a.logoffclosebrowser));"undefined"!=typeof a.logoffidle&&
"-1"!=a.logoffidle&&(lpdbg("idle","overriding idleLogoffVal with value from server: "+a.logoffidle),lpPutUserPref("idleLogoffVal",a.logoffidle));"undefined"!=typeof a.noexport&&"-1"!=a.noexport&&lpPutUserPref("noexport",a.noexport);lpWriteAllPrefs();LP.sitepwlen="string"==typeof a.sitepwlen&&""!=a.sitepwlen?JSON.parse(a.sitepwlen):[];"undefined"!=typeof a.hideidentities&&"-1"!=a.hideidentities&&(g_hideidentities="1"==a.hideidentities);g_savesitestopersonal="string"==typeof a.savesitestopersonal&&
""!=a.savesitestopersonal?a.savesitestopersonal.split(","):[]}function lpAcctsError(){L("Error xhr_accts")}function loglogin(a){get_selected_tab(null,function(c){logloginurl(a,c)})}function tab_is_private(a){return g_isfirefoxsdk?g_private_browsing.isPrivate(a):"undefined"!=typeof a.incognito&&a.incognito}function loglogintab(a,c){tab_is_private(c)||logloginurl(a,gettaburl(c))}
function logloginurl(a,c){var b=lp_get_gmt_timestamp();if("undefined"!=typeof g_sites[a]){if(parseFloat(b)<5+parseFloat(g_sites[a].last_touch))return;g_sites[a].last_touch=b;writenewts(a,b)}else if("undefined"!=typeof g_securenotes[a]){if(b==g_securenotes[a].last_touch)return;g_securenotes[a].last_touch=lp_get_gmt_timestamp();rewritelocalfile();if(!g_loglogins||4!=(g_loglogins&4))return}if(g_loglogins){var b="id="+en(a)+"&method="+encodeURIComponent(get_method()),d=getacct(a);1<g_loglogins&&d&&(2==
(g_loglogins&2)&&"http://sn"!=d.url&&(b+="&u="+en(AES.url2hex(c))),4==(g_loglogins&4)&&(b+="&n="+en(AES.url2hex(d.name))),8==(g_loglogins&8)&&(b+="&un="+en(AES.url2hex(getusernamefromacct(d)))));d&&(d=issharedfolder(g_shares,d.group))&&(b+="&sharedfolderid="+en(d.id));lpMakeRequest(loglogin_url+"loglogin.php",b,null,null)}}function logmpwreuse(a){if(requirechangereuse()||g_loglogins)a="plog=1&u="+encodeURIComponent(a),lpMakeRequest(loglogin_url+"loglogin.php",a,null,null)}
function writenewts(a,c){var b=function(b){b=(null==b?"":b).split("\n");for(var d="",g=0;g<b.length;g++)0!=b[g].indexOf(a+" ")&&""!=b[g]&&(d+=b[g]+"\n");d+=a+" "+c+"\n";(g_is_win||g_is_mac&&LPISLOC)&&have_binary_function("write_file")&&call_binary_function("write_file",db_prepend(g_username_hash+"_lt.cac"),d);"undefined"!=typeof localStorage&&localStorage_setItem(db_prepend(g_username_hash+"_lt.cac"),d)},d="";(g_is_win||g_is_mac&&LPISLOC)&&have_binary_function("read_file")?call_binary_function("read_file",
db_prepend(g_username_hash+"_lt.cac"),b):("undefined"!=typeof localStorage&&(d=localStorage_getItem(db_prepend(g_username_hash+"_lt.cac"))),b(d))}
function logformfill(a,c){get_selected_tab(null,function(b){if(!tab_is_private(b)&&g_loglogins){b="ffid="+en(a);for(var d=0;d<g_formfills.length;d++)if(g_formfills[d].ffid==a){(d=issharedfolder(g_shares,"undefined"!=typeof g_formfills[d].group?g_formfills[d].group:""))&&(b+="&sharedfolderid="+en(d.id));break}c&&(b+="&u="+bin2hex(c));lpMakeRequest(base_url+"logformfill.php?"+b,"",null,null)}})}
function lpCreateKeyFileData(){if("undefined"!=typeof g_pwdeckey&&null!=g_pwdeckey&&"undefined"!=typeof g_local_key&&null!=g_local_key){var a=AES.bin2hex(g_local_key),a=AES.Encrypt({pass:g_pwdeckey,data:a,b64:!0,mode:"ecb",bits:256}),c=AES.Encrypt({pass:g_local_key,data:"lastpass rocks",b64:!0,mode:"ecb",bits:256});return a+"\n"+c}return""}
function lpWriteKeyFile(){console_log("server.js : lpWriteKeyFile : start");var a=lpCreateKeyFileData();""!=a?(console_log("server.js : lpWriteKeyFile : calling lpSaveData"),lpSaveData(a,"key"),(g_is_win||g_is_mac||g_is_linux)&&have_binary_function("write_file")?(console_log("server.js : lpWriteKeyFile : calling protect_data"),protect_data(a,!0,null,function(a){console_log("server.js : lpWriteKeyFile : protect_data callback");console_log("server.js : lpWriteKeyFile : calling binary function to write keyfile");
call_binary_function("write_file",db_prepend(g_username_hash+"_lpall.slps"),a)})):console_log("server.js : lpWriteKeyFile : did not have binary function, so not writing")):console_log("server.js : lpWriteKeyFile : not writing A")}
function lpReadKeyFile(a,c,b,d){console_log("server.js : lpReadKeyFile fromwebsite="+c+" silent="+b+" bIsLoginCheck="+d);b=opendb();createDataTable(b);if(b){console_log("server.js : lpReadKeyFile : reading db");console_log("server.js : lpReadKeyFile : starting db transaction");var e=function(b,e){console_log("server.js : lpReadKeyFile : reading numrows="+e.rows.length);if(0<e.rows.length){var f=e.rows.item(0).data;if(f)if(f=f.split("\n"),2==f.length){var g=null,g=a?AES.hex2bin(lpdec(f[0],g_pwdeckey)):
g_local_key;if("lastpass rocks"==lpdec(f[1],g)){g_local_key=g;g_local_key_hex=AES.bin2hex(g);g_local_key_hash=SHA256(g_local_key);if(a){console_log("server.js : lpReadKeyFile : worked -- calling lpLoginResponse_win2");lpLoginResponse_win2(a,c,d);return}loggedIn();console_log("server.js : lpReadKeyFile worked -- calling get_accts_local");get_accts_local(!0)}else console_log("server.js : lpReadKeyFile : data was corrupt A")}else console_log("server.js : lpReadKeyFile : data was corrupt B");else console_log("server.js : lpReadKeyFile : did not find any data")}else console_log("server.js : lpReadKeyFile : failed to read -- calling lp_login_from_saved"),
lp_login_from_saved();a&&loggedOut(!1,"keyfailed")},f=function(a,b){console_log("server.js : lpReadKeyFile failed error="+b)};if(LPISLOC)console_log("server.js : lpReadKeyFile calling read_key_from_file"),read_key_from_file(function(a){console_log("server.js : lpReadKeyFile read_key_from_file callback");""!=a?e(tx,{rows:{length:1,item:function(){return{data:a}}}}):e(tx,{rows:{length:0}})});else if(console_log("server.js : lpReadKeyFile calling executeSql"),g_indexeddb){var g={rows:{item:function(a){return this[a]},
length:0}};b.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(g_username_hash)+"_key")).onsuccess=function(a){(a=a.target.result)?(g.rows[g.rows.length]=a.value,g.rows.length++,a["continue"]()):e(null,g)}}else b.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND type=?",[db_prepend(g_username_hash),"key"],e,f)})}else console_log("server.js : lpReadKeyFile : failed to open database")}
function lpCheckForKey(a){var c=opendb();createDataTable(c);if(c){var b=function(b,c){0<c.rows.length?a():console_log("no key")},d=function(a,b){console_log(b)};if(LPISLOC)read_key_from_file(function(a){""!=a?b(tx,{rows:{length:1,item:function(){return{data:a}}}}):b(tx,{rows:{length:0}})});else if(g_indexeddb){var e={rows:{item:function(a){return this[a]},length:0}};c.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(g_username_hash)+"_key")).onsuccess=
function(a){(a=a.target.result)?(e.rows[e.rows.length]=a.value,e.rows.length++,a["continue"]()):b(null,e)}}else c.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? AND type=?",[db_prepend(g_username_hash),"key"],b,d)})}}
function lpReadAcctsData(a,c,b,d){function e(a){"string"==typeof a&&(g=a);write_history({cmd:"get_accts_local",status_s:g,sz:f,lver:g_local_accts_version,sver:g_server_accts_version})}if(null==g_username||""==g_username)e("error");else{var f=-1,g="ok",h=opendb();createDataTable(h);if(h){var k=function(g,h){if(0<h.rows.length){if((data=h.rows.item(0).data)&&""!=data){data=checkIterationsInDataFile(data);if("iterationserror"==data){console_log("server.js : local accts data corrupt - key mismatch. redownloading");
e("error");get_accts();return}if(a&&(!sesame_getdata("password_offline")||""==sesame_getdata("password_offline")||!yubikey_getdata("password_offline")||""==yubikey_getdata("password_offline")||!multifactor_getdata("password_offline")||""==multifactor_getdata("password_offline"))){if(0==data.substring(0,30).indexOf("type=sesameoffline\ndata=")){sesame_setdata("offline","1");sesame_getotp(g_username);return}if(0==data.substring(0,30).indexOf("type=trueapioffline\ndata=")||0==data.substring(0,30).indexOf("type=omnikeyoffline\ndata=")){multifactor_setdata("offline",
"1");multifactor_setdata("type",0==data.substring(0,30).indexOf("type=trueapioffline\ndata=")?"trueapi":"omnikey");multifactor_getresponse(g_username);return}if(0==data.substring(0,30).indexOf("type=yubikeyoffline\ndata=")){yubikey_setdata("offline","1");yubikey_getotp(g_username);return}}var j=null;sesame_getdata("password_offline")&&""!=sesame_getdata("password_offline")&&0==data.substring(0,30).indexOf("type=sesameoffline\ndata=")?(lpdbg("sesame","decrypting accounts file after reading"),data=
data.substring(24),j=sesame_getdata("password_offline")):multifactor_getdata("password_offline")&&""!=multifactor_getdata("password_offline")&&(0==data.substring(0,30).indexOf("type=trueapioffline\ndata=")||0==data.substring(0,30).indexOf("type=omnikeyoffline\ndata="))?(lpdbg("multifactor","decrypting accounts file after reading"),data=data.substring(25),j=multifactor_getdata("password_offline")):yubikey_getdata("password_offline")&&(""!=yubikey_getdata("password_offline")&&0==data.substring(0,30).indexOf("type=yubikeyoffline\ndata="))&&
(lpdbg("yubikey","decrypting accounts file after reading"),data=data.substring(25),j=yubikey_getdata("password_offline"));j&&(data=dec(data,hex2bin(j)))}LPISLOC&&(5<=data.length&&"LPB64"==data.substring(0,5))&&(data=data.substring(5));try{data=atob(data),f=data.length,b&&d(data)}catch(k){console_log("server.js : local accts data corrupt. redownloading");e("error");get_accts();return}j=get_version(data);if(j!=g_server_accts_version&&-1!=g_server_accts_version)console_log("server.js : local accts version is outdated: local:"+
j+" server:"+g_server_accts_version+" redownloading"),get_accts();else{L("using cached accts data");if(hassites()&&(!c||"refetchsharing"!=c)){L("Cached data already in place, ABORT, to avoid reparse.");e("abort");return}lp_enterpriseuser=lp_premium_exp=0;j=get_ff_translation("ff_captcha_regexp");lp_captcha_regexp=""!=j?RegExp(j,"i"):null;parsemobile(data,data.length,100,0,postacctsload,[],[],[],[],[],[],[],!0,!0,null,[],[],[],[],[],[],lp_rsaprivatekeyhex,[],null,null,null,[],[],[],[],void 0,void 0,
g_emer_sharers,g_emer_sharees,g_totp);g_premium_exp=lp_premium_exp;g_enterpriseuser=lp_enterpriseuser}}else g_username_hash&&get_accts();e()},j=function(a,b){console_log(b);g="error"};if(LPISLOC)read_accts_from_file(function(a){""!=a?k(tx,{rows:{length:1,item:function(){return{data:a}}}}):k(tx,{rows:{length:0}})});else if(g_indexeddb){var l={rows:{item:function(a){return this[a]},length:0}};h.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(g_username_hash)+
"_accts")).onsuccess=function(a){(a=a.target.result)?(l.rows[l.rows.length]=a.value,l.rows.length++,a["continue"]()):k(null,l)}}else h.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? and type=?",[db_prepend(g_username_hash),"accts"],k,j)})}else get_accts()}}
function MakeOTP(){if(!(null==g_username||0==g_username.length))if(!(null==g_local_key||0==g_local_key.length)){var a=fix_username(g_username);rng_seed_time();for(var c=[],b=0;16>b;b++)c[b]=0;rng_get_bytes(c);for(var d="",b=0;16>b;b++)d+=String.fromCharCode(c[b]);var c=enc(AES.bin2hex(d),g_local_key),e=make_lp_key(g_username,d),b=enc(AES.bin2hex(g_local_key),e),a=SHA256(SHA256(a+d)+d),f=AES.hex2bin(dec(b,e,1));g_local_key!=f?console_log("server.js : ERROR: Failed to decrypt newly encrypted key: dec_local_key:\n"+
AES.bin2hex(f)+" != \n"+AES.bin2hex(g_local_key)+"\nlen: "+f.length+" vs "+g_local_key.length+"\nrand pw:"+AES.bin2hex(d)+"\ng_username:"+g_username+"\nrand key:"+AES.bin2hex(e)+"\nrand_encrypted_key:"+b):(a="newkey=1&xml=1&hash="+LP.en(a),a+="&encrypted_otp="+LP.en(c),a+="&rand_encrypted_key="+LP.en(b),LP.lpMakeRequest(base_url+"otp.php",a+"&recovery=1",lpOTPUploadResponse,function(){},d))}}function DeleteOTP(){DeleteFromDB("otp")}
function DeleteFromDB(a){if(!(null==g_username||""==g_username))if(!LPISLOC||!("key"==a||"accts"==a)){var c=opendb();createDataTable(c);if(c)if(g_indexeddb)c.transaction("LastPassData","readwrite").objectStore("LastPassData")["delete"](db_prepend(g_username_hash)+"_"+a);else c.transaction(function(b){b.executeSql("DELETE FROM LastPassData WHERE username_hash=? and type=?",[db_prepend(g_username_hash),a],function(){},function(a,b){console_log(b)})})}}
function GetOTPHash(a,c,b,d){a&&(a+="&outofbandsupported=1");var e=opendb();createDataTable(e);if(e){var f=b?SHA256(b):g_username_hash,g=b?b:g_username,h=function(b,e){var f="";0<e.rows.length&&(f=e.rows.item(0).data);a?(""!=f?(f=AES.hex2bin(f),lostotphash=SHA256(SHA256(fix_username(g)+f)+f)):lostotphash="",1==lpGetPref("storeLostOTP",1)&&(a+="&lostpwotphash="+en(lostotphash)),sesame_setdata("postdata",a),yubikey_setdata("postdata",a),googleauth_setdata("postdata",a),outofband_setdata("postdata",
a),securityquestion_setdata("postdata",a),grid_setdata("postdata",a),multifactor_setdata("postdata",a),g_lastpoll=lastlogin=(new Date).getTime(),console_log("server.js : Requesting login.php A"),lpMakeRequest(base_url+"login.php",a,lpLoginResponse,lpLoginError)):null!=c&&(lostotphash=""==f?"nouser":f,sendCS(c,{cmd:"recover",otp:lostotphash},d))};if(g_indexeddb){var k={rows:{item:function(a){return this[a]},length:0}};e.transaction("LastPassData","readonly").objectStore("LastPassData").openCursor(IDBKeyRange.only(db_prepend(f)+
"_otp")).onsuccess=function(a){(a=a.target.result)?(k.rows[k.rows.length]=a.value,k.rows.length++,a["continue"]()):h(null,k)}}else e.transaction(function(a){a.executeSql("SELECT * FROM LastPassData WHERE username_hash=? and type=?",[db_prepend(f),"otp"],h,function(a,b){console_log(b)})})}else g_lastpoll=lastlogin=(new Date).getTime(),console_log("server.js : Requesting login.php B"),lpMakeRequest(base_url+"login.php",a,lpLoginResponse,lpLoginError)}
function lpOTPUploadResponse(a,c,b){4==a.readyState&&(200==a.status&&a.responseXML&&a.responseXML.documentElement)&&(a=opendb(),createDataTable(a),a&&(g_indexeddb?a.transaction("LastPassData","readwrite").objectStore("LastPassData").put({username_hash:db_prepend(g_username_hash),type:"otp",data:AES.bin2hex(b),usertype:db_prepend(g_username_hash)+"_otp"}):a.transaction(function(a){a.executeSql("REPLACE INTO LastPassData (username_hash, type, data) VALUES (?, ?, ?)",[db_prepend(g_username_hash),"otp",
AES.bin2hex(b)],function(){console_log("server.js : inserted")},function(a,b){console_log(b)})})))}
function savePassword(a,c,b,d){var e=lp_gettld_url(c);if(0==c.indexOf("chrome://")||0==c.indexOf("chrome-extension://"))e=c="Browser";e=gs("Generated Password for")+" "+e;a="url="+en(AES.url2hex(c))+"&password="+en(lpenc(a))+"&name="+en(lpenc(e));a+=get_identity_param();d&&(a+="&nofill=1");a+="&token="+encodeURIComponent(g_token);lpMakeRequest(base_url+"save_gen_pw.php",a,lpPopulateGeneratedPassword,null,b)}
function lpPopulateGeneratedPassword(a,c,b){if(4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){a=a.responseXML.documentElement;c=a.getElementsByTagName("error");if(0<c.length&&(c=c[0].getAttribute("notloggedin"))&&"1"==c){loggedOut(!1,"lpPopulateGeneratedPassword");return}a=a.getElementsByTagName("ok");if(0<a.length){c=AES.hex2url(a[0].getAttribute("url"));var d=crypto_atob(a[0].getAttribute("password")),e={cmd:"populategeneratedpassword",url:c,password:lpmdec(d,!0),
nofill:a[0].getAttribute("nofill"),ff_currpass_regexp:get_ff_translation("ff_currpass_regexp")};sendCS(b,e,"all");b=createNewAcct();b.tld=lp_gettld_url(c);e=gs("Generated Password for")+" "+b.tld;b.aid=a[0].getAttribute("aid");"undefined"==typeof g_tlds[b.tld]&&(g_tlds[b.tld]=[]);g_tlds[b.tld][b.aid]=!0;add_ident_aid(b.aid);b.url=c;b.name=e;b.password=d;b.genpw=1;g_sites[b.aid]=b;g_local_accts_version++;rewritelocalfile();b=a[0].getAttribute("accts_version");compare_accounts_versions(b,g_local_accts_version)||
get_accts();refresh_windows()}}}function addeditformfill(a,c,b,d){var e="",f;for(f in a)e+=(""==e?"":"&")+f+"="+en(a[f]);a=!1;"undefined"!=typeof c.group&&""!=c.group&&(a=issharedfolder(g_shares,c.group));e+=!1==a?"":"&sharedfolderid="+en(a.id);e+=get_identity_param();lpMakeRequest(base_url+"formfill.php",e,lpAddEditFormFillResponse,d,{site:c,successCallback:b,errorCallback:d});return!0}
function deleteformfill(a,c,b,d,e,f){if(b&&!frame_and_topdoc_has_same_domain(d)&&(ftd_report_error(d,"deleteformfill"),!lpConfirmYesNo(gs("Are you sure you would like to delete this Form Fill from your LastPass vault?"))))return!1;if(!c)for(b=0;b<g_formfills.length;b++)if(g_formfills[b].ffid==a){if(g_formfills[b].pwprotect||g_prompts.view_ff_prompt)return security_prompt(function(){deleteformfill(a,!0)}),!1;break}c=!1;for(b=0;b<g_formfills.length;b++)if(g_formfills[b].ffid==a){c=issharedfolder(g_shares,
"undefined"!=typeof g_formfills[b].group?g_formfills[b].group:"");g_formfills.splice(b,1);break}g_local_accts_version++;rewritelocalfile();b="deleteext=1&ffid="+LP.en(a);b+=!1==c?"":"&sharedfolderid="+en(c.id);b+=get_identity_param();lpMakeRequest(base_url+"formfill.php",b,lpDeleteFormFillResponse,f,{ffid:a,successCallback:e,errorCallback:f});return!0}
function lpAddEditFormFillResponse(a,c,b){c=b.site;if(4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){a=a.responseXML.documentElement;var d=a.getElementsByTagName("error");if(0<d.length){var e=d[0].getAttribute("notloggedin");if(e&&"1"==e){loggedOut(!1,"lpAddEditFormFillResponse");return}(d=d[0].getAttribute("response"))&&(b.errorCallback?b.errorCallback(d):alertfrombg(d))}d=a.getElementsByTagName("result");if(0<d.length){d[0].getAttribute("msg");a=d[0].getAttribute("ffid");
for(var f=d[0].getAttribute("cfids"),d=d[0].getAttribute("accts_version"),e=[],g=""==f?[]:f.split(","),h=0,f=1;"undefined"!=typeof c["customfield"+f+"cfid"];++f){var k={};k.cfid=0!=c["customfield"+f+"cfid"]?c["customfield"+f+"cfid"]:h<g.length?g[h++]:0;k.text=c["customfield"+f+"text"];k.value=c["customfield"+f+"value"];k.alttext=c["customfield"+f+"alttext"];(""!=k.text||""!=k.value||""!=k.alttext)&&e.push(k)}g=c.cmd;delete c.cmd;delete c.deleteext;for(f=1;"undefined"!=typeof c["customfield"+f+"cfid"];++f)delete c["customfield"+
f+"cfid"],delete c["customfield"+f+"text"],delete c["customfield"+f+"value"],delete c["customfield"+f+"alttext"];c.custom_fields=e;if("add"==g)c.ffid=a,add_ident_ffid(a),g_formfills.push(c);else for(f=0;f<g_formfills.length;++f)if(a==g_formfills[f].ffid){g_formfills[f]=c;break}g_formfills.sort(function(a,b){return a.decprofilename.toLowerCase()<b.decprofilename.toLowerCase()?-1:1});g_local_accts_version++;rewritelocalfile();compare_accounts_versions(d,g_local_accts_version)||get_accts();refresh_windows();
b.successCallback&&b.successCallback(c);do_experimental_popupfill&&setTimeout(function(){recheckpage()},50)}}}
function lpDeleteFormFillResponse(a,c,b){if(4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){a=a.responseXML.documentElement;c=a.getElementsByTagName("error");if(0<c.length&&(c=c[0].getAttribute("notloggedin"))&&"1"==c){loggedOut(!1,"lpDeleteFormFillResponse");return}a=a.getElementsByTagName("result");0<a.length&&(a=a[0].getAttribute("accts_version"),compare_accounts_versions(a,g_local_accts_version)||get_accts(),refresh_windows(),b.successCallback&&b.successCallback(),
do_experimental_popupfill&&setTimeout(function(){recheckpage()},50))}}
function saveSiteFromSubmit(a,c,b,d){a+="&auto=1"+get_identity_param();a=g_introTutorialStatus&&g_introTutorialStatus.getTile()?a+("&source=bar"+g_introTutorialStatus.getTile()):a+"&source=bar";try{for(var e in g_sites)if(g_sites[e].genpw&&g_sites[e].tld==c.tld&&lpmdec_acct(g_sites[e].password,!0,g_sites[e],g_shares)==lpmdec_acct(c.password,!0,c,g_shares)){a+="&delgenpwaid="+LP.en(e);break}}catch(f){}c={url:base_url+"deliver_and_add.php",postdata:a,successCallback:b,errorCallback:d,acct:c};handleOfflineAccountUpdate(c,
g_sites,"aid");lpMakeRequest(c.url,a,lpSaveSiteResponse,d,c)}function updateFieldsFromSubmit(a,c){a+="&auto=1"+get_identity_param();var b={url:base_url+"gm_deliver.php",postdata:a,acct:c};lpMakeRequest(b.url,a,lpUpdateFieldsResponse,null,b)}
function handleOfflineAccountUpdate(a,c,b){if(a.successCallback&&isOffline()){if("0"===a.acct[b]){var d=Preferences.get("tempID")+1;a.acct[b]=d.toString();Preferences.set("tempID",d)}c[a.acct[b]]=a.acct;a.successCallback(a.acct);increment_local_accts_version();rewritelocalfile();delete a.successCallback;delete a.errorCallback}}
function saveAllSite(a,c,b,d){a+="&auto=1"+get_identity_param();c={url:base_url+"show.php",postdata:a,successCallback:b,errorCallback:d,acct:c};handleOfflineAccountUpdate(c,g_sites,"aid");lpMakeRequest(c.url,a,lpSaveSiteResponse,c.errorCallback,c)}
function saveSite(a,c,b,d){a+="&auto=1"+get_identity_param();var e=is_application(c);b={url:base_url+(e?"addapp.php":"show.php"),postdata:a,successCallback:b,errorCallback:d,acct:c};handleOfflineAccountUpdate(b,c.sn?g_securenotes:e?g_applications:g_sites,e?"appaid":"aid");lpMakeRequest(b.url,a,lpSaveSiteResponse,b.errorCallback,b)}function openLinkedSites(a,c,b){setTimeout(function(){openchangepw(a,c,b)},700)}
function lpSaveSiteResponse(a,c,b){b.aid=b.acct.aid;b.newvalues=b.acct.newvalues;b.handler=lpSaveSiteResponse;if(!rsa_shareeautopushesresponse(a,b)&&4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){c=b.acct;var d=a.responseXML.documentElement;a=d.getElementsByTagName("error");if(0<a.length){var e=a[0].getAttribute("notloggedin");if(e&&"1"==e){loggedOut(!1,"lpSaveSiteResponse");return}(a=a[0].getAttribute("response"))&&(b.errorCallback?b.errorCallback(a):alertfrombg(a))}e=
d.getElementsByTagName("result");if(0<e.length){a=0;("accountreplaced"==e[0].getAttribute("msg")||b.successCallback)&&a++;c.submit_id=e[0].getAttribute("submit_id");c.captcha_id=e[0].getAttribute("captcha_id");c.custom_js=e[0].getAttribute("custom_js");var f=e[0].getAttribute("attacherror");f&&""!=f&&alertfrombg(f);checkIconsVersion();checkBigIconsVersion(c.posturl);inc=0;for(newattach=[];null!=e[0].getAttribute("att_"+inc);)newattach[e[0].getAttribute("att_"+inc)]=[],newattach[e[0].getAttribute("att_"+
inc)].key=e[0].getAttribute("attstorekey_"+inc),newattach[e[0].getAttribute("att_"+inc)].size=e[0].getAttribute("attsize_"+inc),inc++;var g=is_application(c)?"0"===c.appaid:"0"===c.aid;if(g){var h=e[0].getAttribute("aid"),k=e[0].getAttribute("urid");c.aid=c.fiid=h;c.urid=k;if(c.fields)for(var j=get_ff_translation("ff_captcha_regexp"),h=""!=j?RegExp(j,"i"):null,j=0;j<c.fields.length;j++)if(!c.fields[j].otherfield&&"1"!=c.fields[j].otherlogin&&(c.fields[j].urid=k),h&&("undefined"==typeof c.captcha_id||
""==c.captcha_id)&&"text"==c.fields[j].type&&h.exec(c.fields[j].name))c.captcha_id=c.fields[j].name;add_ident_aid(c.aid);if(c.sn)g_securenotes[c.aid]=c;else{if("undefined"==typeof c.tld||""==c.tld)c.tld=lp_gettld_url(c.url);"undefined"==typeof g_tlds[c.tld]&&(g_tlds[c.tld]=[]);g_tlds[c.tld][c.aid]=!0;g_sites[c.aid]=c}for(j in g_sites)g_sites[j].genpw&&(g_sites[j].tld==c.tld&&lpmdec_acct(g_sites[j].password,!0,g_sites[j],g_shares)==lpmdec_acct(c.password,!0,c,g_shares))&&("undefined"!=typeof g_tlds[g_sites[j].tld]&&
"undefined"!=typeof g_tlds[g_sites[j].tld][j]&&delete g_tlds[g_sites[j].tld][j],delete g_sites[j]);if((d=d.getElementsByTagName("field"))&&0<d.length){c.fields=[];for(j=0;j<d.length;j++){h=d[j];k={};k.name=h.getAttribute("name");k.type=h.getAttribute("type");k.value=h.getAttribute("value");if(is_encrypted_field(k.type))k.value=crypto_atob(k.value);else if("checkbox"==k.type||"radio"==k.type)if(k.checked=!1,h=k.value.match(/-([0-1])$/))"1"==h[1]&&(k.checked=!0),k.value=k.value.substring(0,k.value.length-
2);k.formname="";c.fields[j]=k}a++}}if("undefined"!=typeof c.attacharraychanges&&(!f||""==f)){if("undefined"!=typeof c.attacharraychanges.add)for(j in c.attacharraychanges.add)c.attacharraychanges.add.hasOwnProperty(j)&&(c.attachpresent="1",f=c.attacharraychanges.add[j],g&&(f.parent=c.aid,f.id=c.aid+"-"+f.id),f.size=newattach[f.id].size,f.storagekey=newattach[f.id].key);applyattacharraychanges(c.attacharraychanges);c.attacharraychanges={}}else f&&""!=f&&"undefined"!=typeof c.attacharraychanges&&rollbackattacharrayadds(c.attacharraychanges);
j=e[0].getAttribute("accts_version");g_local_accts_version+=a;compare_accounts_versions(j,g_local_accts_version)?rewritelocalfile():get_accts();if("undefined"!=typeof c.retrieveattach&&1==c.retrieveattach){var l=function(){console.log("lpSaveSiteResponse : attachversion="+attachversion+" > lp_local_attach_version="+lp_local_attach_version+" --- calling getattach.php");var a="version="+LP.en(lp_local_attach_version)+"&b64=1&chunked=1";LP.lpMakeRequest(base_url+"getattach.php",a,lpSaveAttach)};null==
lp_local_attach_version||-1==lp_local_attach_version?ReadFileGeneric(lpusername_hash+"_version.att",25,function(a){(lp_local_attach_version=a)||(lp_local_attach_version=0);l()}):l();c.retrieveattach=null}refresh_windows();b.successCallback&&(c.sn?g_securenotes[c.aid]=c:is_application(c)?g_applications[c.appaid]=c:g_sites[c.aid]=c,b.successCallback(c));do_experimental_popupfill&&(setTimeout(function(){recheckpage()},50),"undefined"!==typeof g_show_save_success_msg&&g_show_save_success_msg&&(doPopupSaveOK(g_popup_tabid_save),
g_popup_tabid_save=null))}}}
function lpUpdateFieldsResponse(a,c,b){b.aid=b.acct.aid;b.newvalues=b.acct.newvalues;b.handler=lpUpdateFieldsResponse;if(!rsa_shareeautopushesresponse(a,b)&&4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){c=b.acct;a=a.responseXML.documentElement;b=a.getElementsByTagName("error");if(0<b.length&&(b=b[0].getAttribute("notloggedin"))&&"1"==b){loggedOut(!1,"lpUpdateFieldsResponse");return}a=a.getElementsByTagName("ok");if(0<a.length){b=a[0].getAttribute("accts_version");if(compare_accounts_versions(b,
g_local_accts_version)){a=a[0].getAttribute("urid");b="0"==c.urid;var d=!b;b&&(c.urid=a);if(c.fields)for(var e=0;e<c.fields.length;e++)b&&!c.fields[e].otherfield&&"1"!=c.fields[e].otherlogin?c.fields[e].urid=a:d&&(!c.fields[e].otherfield&&"1"==c.fields[e].otherlogin&&"0"==c.fields[e].urid)&&(c.fields[e].urid=a)}else get_accts();refresh_windows()}}}
function addNever(a){g_neverurls.neveraccounts.push(a);g_local_accts_version++;rewritelocalfile();a="url="+en(url2hex(a));lpMakeRequest(base_url+"add_never.php",a,null,null)}
function deleteGroup(a,c,b,d,e,f,g){d="undefined"==typeof f?null:f;g=g||!1;issharedfolder(g_shares,a);f="";for(var h in g_sites)g_sites[h].group==a&&(f+=(""==f?"":",")+h);for(h in g_securenotes)g_securenotes[h].group==a&&(f+=(""==f?"":",")+h);for(h in g_applications)g_applications[h].group==a&&(f+=(""==f?"":",")+"app"+h);if(""==f&&!e)return deleteGroup("\\"+a,c,b,"deleteGroup",1,d);if(""==f&&1==e){if(null==d){console_log("server.js : Failed to find group and groupid is null");return}e=null;f="";for(h in g_sites)if(g_sites[h].id==
d){e=g_sites[h].group;break}if(null==e)for(h in g_securenotes)if(g_securenotes[h].id==d){e=g_securenotes[h].group;break}if(null==e)for(h in g_applications)if(g_applications[h].id==d){e=g_applications[h].group;break}if(null!=e){for(h in g_sites)g_sites[h].group==a&&(f+=(""==f?"":",")+h);for(h in g_securenotes)g_securenotes[h].group==a&&(f+=(""==f?"":",")+h);for(h in g_applications)g_applications[h].group==a&&(f+=(""==f?"":",")+"app"+h)}""==f&&(f=d,console_log("server.js : Still couldn't find stuff -- just using the passed groupid : aids="+
f))}return deleteAid(f,c,!1,g,b,a)}function checkmultiplefolders(a){for(var c=!1,b=null,d=!0,e=0;e<a.length;e++){var f=get_record(a[e]);if(f)if(f=issharedfolder(g_shares,f.group))if(c){d=!1;break}else if(null==b)b=f.decsharename;else{if(b!=f.decsharename){d=!1;break}}else if(null!=b){d=!1;break}else c=!0}d||alertfrombg(gs("Sorry, you cannot perform this operation on a mix of shared and non-shared folders, or multiple shared folders at once."));return d}
function deleteAid(a,c,b,d,e,f,g,h){if(g&&!frame_and_topdoc_has_same_domain(h)&&(f=get_record(a),g="",f&&((g=f.useusername)||f.unencryptedUsername,g||f.sitename,g||f.name),ftd_report_error(h,"deleteaid"),!lpConfirmYesNo(gs("Are you sure you would like to delete this site from your LastPass vault?")+"\n\n"+g)))return!1;var k=a.split(",");if(!checkmultiplefolders(k))return!1;f="";for(g=h=0;g<k.length;g++){var j=k[g];if(is_application(j)){if(!check_ident_appaid(j))continue}else if(!check_ident_aid(j))continue;
var l,p;is_application(j)?(l=get_record(j),p=!1):(l=g_sites[j],p=g_prompts.edit_site_prompt,l||(p=g_prompts.edit_sn_prompt,l=g_securenotes[j]));if(l){f+=(""==f?"":",")+j;if("undefined"!=typeof l.sharefolderid&&(h=l.sharefolderid,j=issharedfolder(g_shares,l.group),!checkreadonly(j)))return!1;if(!b&&(l.pwprotect||p))return security_prompt(function(){deleteAid(a,c,!0,d,e)}),!1}}if(""==f)return!1;b=gs("Are you sure you would like to delete this site?");l.genpw?b=gs("Are you sure you would like to delete this generated password?"):
l.sn?b=gs("Are you sure you would like to delete this secure note?"):is_application(l)&&(b=gs("Are you sure you would like to delete this application?"));l.name&&l.name.length&&(b+=" ("+l.name+")");1<k.length&&(b=gs("Are you sure you would like to delete the selected items?"));l.group&&"http://group"==l.url&&(b=gs("Are you sure you would like to delete this group?")+" ("+l.group+")");if(!d)if(null==c){if(!g_isopera&&!confirm(b))return!1}else if(!g_isopera&&!c.confirm(b))return!1;k=f.split(",");b=
"";for(g=0;g<k.length;g++)if(j=k[g],is_application(j))delete g_applications[get_appaid(j)];else{if(!l.sn&&"http://group"!=l.url)try{delete g_tlds[l.tld][j],8==(g_loglogins&8)&&(b+=(""==b?"":",")+getusernamefromacct(g_sites[j]))}catch(q){}delete g_sites[j];delete g_securenotes[j]}g_local_accts_version++;rewritelocalfile();l="ajax=1&extjs=1&delete=1&aid="+en(f);l+=get_identity_param();0!=h&&(l+="&sharedfolderid="+en(h));""!=b&&(l+="&un="+en(AES.url2hex(b)));lpMakeRequest(base_url+"show.php",l,lpDeleteResponse);
e&&e();return!0}function lpDeleteResponse(a){a&&(4==a.readyState&&200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement)&&(a=a.responseXML.documentElement.getElementsByTagName("result"),0<a.length&&(a=a[0].getAttribute("accts_version"),compare_accounts_versions(a,g_local_accts_version)||get_accts(),refresh_windows()))}
function editAid(a,c,b,d){if(check_ident_aid(a))if(VaultToggle.useVault4_0()&&!d)g_sites[a]?LPPlatform.openTabDialog("site",{vaultItem:a}):is_application(a)?LPPlatform.openTabDialog("application",{vaultItem:0===a.indexOf("app")?a.substring(3):a}):LPPlatform.openTabDialog("note",{vaultItem:a});else{var e,f;is_application(a)?(e=get_record(a),f=!1):(e=g_sites[a],f=g_prompts.edit_site_prompt,e||(f=g_prompts.edit_sn_prompt,e=g_securenotes[a]));if(e)if(!b&&(e.pwprotect||f))e.pwprotect?security_prompt(function(){editAid(a,
c,!0,d)},null,null,!0,a):security_prompt(function(){editAid(a,c,!0,d)});else{g_site_data=[];for(var g in e)g_site_data[g]=e[g];g_site_data.openchpw="1"==d&&"1"==g_site_data.pwch?1:0;var h=0;b=!1;if("undefined"!=typeof e.attachpresent&&"1"==e.attachpresent){g_site_data.attaches=[];for(g in lp_attaches)lp_attaches[g].parent==a&&h++;for(g in lp_attaches)lp_attaches[g].parent==a&&(0==lp_attaches[g].mimetype.indexOf("data:image")?(b=!0,function(a){lpReadAttach(lp_attaches[a].id,function(b){g_site_data.attaches[g_site_data.attaches.length]=
{id:lp_attaches[a].id,mimetype:lp_attaches[a].mimetype,filename:lp_attaches[a].filename,bytes:b};g_site_data.attaches.length==h&&openURL(getchromeurl("site.html"))})}(g)):(g_site_data.attaches[g_site_data.attaches.length]={id:lp_attaches[g].id,mimetype:lp_attaches[g].mimetype,filename:lp_attaches[g].filename,bytes:null},b&&g_site_data.attaches.length==h&&openURL(getchromeurl("site.html"))))}b||openURL(getchromeurl("site.html"))}}}
function saveFields(a,c,b,d,e){if(b&&b.newvalues&&void 0===b.newvalues.length){var f=[],g;for(g in b.newvalues)f.push(b.newvalues[g]);b.newvalues=f}b=b||{};b.successCallback=d;b.errorCallback=e;b.url=base_url+"fields.php?"+a;b.postdata=c;lpMakeRequest(b.url,c,lpSaveFieldsResponse,e,b)}
function lpSaveFieldsResponse(a,c,b){b.handler=lpSaveFieldsResponse;if(!rsa_shareeautopushesresponse(a,b)&&4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement){a=a.responseXML.documentElement;c=a.getElementsByTagName("response");0<c.length&&(c=c[0].getAttribute("message"),console_log("server.js : Save Fields failed: "+c));c=a.getElementsByTagName("error");if(0<c.length&&(c=c[0].getAttribute("notloggedin"))&&"1"==c){loggedOut(!1,"lpSaveFieldsResponse");return}a=a.getElementsByTagName("result");
0<a.length&&(a=a[0].getAttribute("accts_version"),compare_accounts_versions(a,g_local_accts_version)||get_accts(),refresh_windows(),b&&b.successCallback&&b.successCallback())}}var g_lastpoll=null;
function poll_server_request(){if(!(null!=g_lastpoll&&g_lastpoll>(new Date).getTime()-2)&&(g_lastpoll=(new Date).getTime(),lploggedin&&null==grid_getdata("active"))){var a=pollserver_url+"poll_server.php",c="";lpsendmpstrength&&null!=lpmpstrength&&(c+="&mpstrength="+LP.en(lpmpstrength));if(!0==g_prompts.improve)for(var b in g_events)g_events.hasOwnProperty(b)&&(c+="&"+LP.en(b)+"="+LP.en(g_events[b]));g_events=[];lpMakeRequest(a,c,poll_server_response,null);g_lastpoll=(new Date).getTime()}}
function poll_server(){if(!g_nopoll){if(lploggedin&&null==grid_getdata("active")){var a=(new Date).getTime(),c=lpGetPref("logOffAfterLoggedInVal",0);if(0<c&&a-lastlogin>60*c){lplogoff(!1,"logoffafterloggedin");setTimeout(function(){poll_server()},6E4);return}g_lastpollcheck=a;1==lpGetPref("logoffWhenCloseBrowser",0)&&0<lpGetPref("logoffWhenCloseBrowserVal",0)&&(lpPutUserPref("lastpollcheck",g_lastpollcheck),lpWriteAllPrefs());var b=60*parseInt(lpGetPref("pollServerVal",15)),d=1E3*b,e=function(b){if("locked"==
b||"idle"==b)d*=g_logoff_other_ses?12:60;a-g_lastpoll>=d&&poll_server_request()};0<d&&(c=function(a){a?call_binary_function("get_idle_ms",function(a){e(a>=d?"idle":"active")}):enable_native_idle&&"undefined"!=typeof chrome&&"undefined"!=typeof chrome.idle?chrome.idle.queryState(b,e):e("active")},have_binary_function("get_idle_ms")?can_check_idle(c):c(!1))}setTimeout(function(){poll_server()},6E4)}}var g_notifications=[];
function handlenotifications(a,c,b){try{if(lplog("notify: title="+a+" text="+c+" url="+b),"undefined"!=typeof webkitNotifications&&webkitNotifications)if(0!=webkitNotifications.checkPermission())lplog("notify: requesting permission"),webkitNotifications.requestPermission(function(){lplog("notify: requesting permission callback called")});else{var d=webkitNotifications.createNotification("images/icon48.png",a,c);if(d){var e=(new Date).getTime()+"_"+Math.floor(100*Math.random());d.ondisplay=function(){lplog("notify: displaying notification id="+
e)};d.onclose=function(){lplog("notify: closing notification id="+e)};d.onclick=function(){lplog("notify: user clicked notification id="+e);b&&""!=b&&(lplog("notify: opening notication url for id="+e+" url="+b),d.cancel(),openURL(b))};d.show();g_notifications.push({id:e,time:(new Date).getTime(),note:d});1==g_notifications.length&&setTimeout(function(){notifications_autoclose()},0)}else lplog("notify: error : failed to create notification")}else g_isfirefoxsdk?g_ff_notifications.notify({title:a,text:c,
iconURL:self.data.url("images/icon48.png"),onClick:function(a){a&&""!=a&&openURL(a)},data:b}):lplog("notify: error: webkitNotifications is null")}catch(f){}}function notifications_autoclose(){}function notifications_closeall(){lplog("notify: closing all notifications");for(var a=0;a<g_notifications.length;++a)lplog("notify: closing notification id="+g_notifications[a].id),g_notifications[a].note.cancel();g_notifications=[]}
function poll_server_response(a){if(4==a.readyState)if(200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement){if(a=a.responseXML.documentElement.getElementsByTagName("ok"),0<a.length){g_logoff_other_ses="1"==a[0].getAttribute("logoff_other_ses")?!0:!1;var c=a[0].getAttribute("accts_version");a[0].getAttribute("newbreach");var b=a[0].getAttribute("newalert");a[0].getAttribute("newbreach_msg");"true"==b&&handle_new_alerts(a[0]);g_server_accts_version=c;c>g_local_accts_version&&get_accts();
var d=a[0].getAttribute("attachversion"),e=function(){if(d>lp_local_attach_version){console.log("poll_server_response : attachversion="+d+" > lp_local_attach_version="+lp_local_attach_version+" --- calling getattach.php");var a="version="+LP.en(lp_local_attach_version)+"&b64=1&chunked=1";LP.lpMakeRequest(base_url+"getattach.php",a,lpSaveAttach)}};null==lp_local_attach_version||-1==lp_local_attach_version?ReadFileGeneric(lpusername_hash+"_version.att",25,function(a){(lp_local_attach_version=a)||(lp_local_attach_version=
0);e()}):e();lpsendmpstrength=null!=a[0].getAttribute("sendmpstrength")?!0:!1;if((c=a[0].getAttribute("note_title"))&&c.length)b=a[0].getAttribute("note_text"),a=a[0].hasAttribute("note_url")?a[0].getAttribute("note_url"):null,handlenotifications(c,b,a)}}else lpReportError("Problem in poll_server_response. status="+a.status,null)}
function upgrade_response(a){if(4==a.readyState)if(200==a.status&&null!=a.responseXML&&null!=a.responseXML.documentElement)if(a=a.responseXML.documentElement.getElementsByTagName("updatecheck"),0<a.length?(upgrade="1"==a[0].getAttribute("upgrade")?!0:!1,upgradeurl=a[0].getAttribute("codebase")):(upgrade=!1,upgradeurl=""),g_ischrome)g_notification_type="upgrade",g_notification_data={upgrade:upgrade,upgradeurl:upgradeurl},sendTS({cmd:"notification",type:"upgrade"});else{if(g_issafari||g_isopera||g_ismaxthon||
g_isfirefoxsdk)upgrade?confirm(gs("An Update is Available. Would you like to install?"))&&openURL(upgradeurl):alertfrombg(gs("No Updates Are Available"))}else lpReportError("Problem in upgrade_response. status="+a.status,null)}
function changePassword(a,c,b,d,e){debug&&console_log("changePassword called");var f=[];f.push(a);for(var g=[],h=0,k=0;k<c.length;k++)g_sites[c[k]]?(lpmdec_acct(g_sites[c[k]].password,!0,g_sites[c[k]],g_shares)!=a&&(g[g.length]=c[k]),"undefined"!=typeof g_sites[c[k]].sharefolderid&&(h=g_sites[c[k]].sharefolderid)):debug&&console_error("skipping bad aid in changePassword "+c[k]);c=g;if(0!=c.length){g_pending_pw_change={};for(var g="xml=1",j=[],l="",k=0;k<c.length;k++){var p=0<k?k:"",g=g+("&username"+
p+"=dummy"),g=g+("&password"+p+"="+LP.en(lpenc_acct(a,g_sites[c[k]],g_shares))),g=g+("&id"+p+"="+LP.en(c[k]));8==(g_loglogins&8)&&(l+=(""==l?"":",")+getusernamefromacct(g_sites[c[k]]));f.push(a);g_pending_pw_change[c[k]]=lpenc_acct(a,g_sites[c[k]],g_shares);try{lp_in_array(g_sites[c[k]].tld,j)||(j[j.length]=g_sites[c[k]].tld)}catch(q){}}try{for(k in g_sites)if(g_sites[k].genpw&&lp_in_array(g_sites[k].tld,j)&&lpmdec_acct(g_sites[k].password,!0,g_sites[k],g_shares)==a){g+="&delgenpwaid="+LP.en(k);break}}catch(n){}0!=
h&&(g+="&sharedfolderid="+en(h));""!=l&&(g+="&un="+en(AES.url2hex(l)));"undefined"!=typeof b&&b&&(g+="&autochange=1");a={aid:0,postdata:g,url:base_url+"change_pw.php",newvalues:f,successCallback:d,errorCallback:e};lpMakeRequest(a.url,g,lpChangePasswordResponse,e,a)}}
function lpChangePasswordResponse(a,c,b){b.handler=lpChangePasswordResponse;if(!rsa_shareeautopushesresponse(a,b)&&4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement)if(a=a.responseXML.documentElement.getElementsByTagName("ok"),0<a.length){debug&&(c=(new Date).getTime(),console_log("received ok response from Password Change at "+c));c=crypto_atob(a[0].getAttribute("newpassword"));for(var d=[],e="";a[0].hasAttribute("oldpassword"+e);){var f=a[0].getAttribute("id"+e),g=crypto_atob(a[0].getAttribute("oldpassword"+
e)),f=g_sites[f];lp_in_array(f.tld,d)||(d[d.length]=f.tld);debug&&L("acct.password="+f.password+" oldpassword="+g+" newpassword="+c);if(f.password==g||lpmdec_acct(f.password,!0,f,g_shares)==lpmdec_acct(g,!0,f,g_shares))f.password=c;if(f.fields)for(var h=0;h<f.fields.length;h++)if("password"==f.fields[h].type&&(f.fields[h].value==g||lpmdec_acct(f.fields[h].value,!0,f,g_shares)==lpmdec_acct(g,!0,f,g_shares)))f.fields[h].value=c;delete g_pending_pw_change[f.aid];f.last_pwchange_gmt=parseInt((new Date).getTime()/
1E3);""==e?e=1:e++}for(h in g_sites)g_sites[h].genpw&&(lp_in_array(g_sites[h].tld,d)&&lpmdec_acct(g_sites[h].password,!0,g_sites[h],g_shares)==lpmdec(c,!0))&&(verbose_log(sprintf("CHG: deleting generated password entry id=%s for password=%s",h,g_show_pw_in_logs||g_isadmin?lpmdec(c,!0):"REDACTED")),"undefined"!=typeof g_tlds[g_sites[h].tld]&&"undefined"!=typeof g_tlds[g_sites[h].tld][h]&&delete g_tlds[g_sites[h].tld][h],delete g_sites[h]);g_local_accts_version++;rewritelocalfile();b.successCallback&&
b.successCallback();b=a[0].getAttribute("accts_version");compare_accounts_versions(b,g_local_accts_version)||get_accts()}else b.errorCallback&&b.errorCallback()}var lpyubidata={};
function yubikey_getotp(a,c){grid_setdata("active","1");lpdbg("yubikey","Asking user for fresh otp");var b=c&&c.getAttribute("trustexpired")?c.getAttribute("trustexpired"):0,d=c&&c.getAttribute("trustlabel")?c.getAttribute("trustlabel"):"";openURL(getchromeurl("lp_toolstrip.html?browseraction=1&yubikey=1&trustexpired="+encodeURIComponent(b)+"&trustlabel="+encodeURIComponent(d)));return""}function yubikey_setdata(a,c){lpyubidata[a]=c}
function yubikey_getdata(a){return"undefined"==typeof lpyubidata[a]?null:lpyubidata[a]}function yubikey_cleardata(){lpdbg("yubikey","clearing data");lpyubidata={}}
function yubikey_auth(a,c){grid_setdata("active",null);if(""!=a)if("1"==yubikey_getdata("offline")){var b=a.substring(0,12);a=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+b)+b));yubikey_setdata("password_offline",a);offlineloginsuccessful("offline",0);lpReadAcctsData();yubikey_setdata("offline","0")}else{var d=b=null,e=null,f=null;yubikey_getdata("postdata")?(b=yubikey_getdata("postdata")+"&otp="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,f=lpLoginError):(b=sesame_getdata("logincheckpostdata")+
"&otp="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);""!=c&&(b+="&trustlabel="+encodeURIComponent(c));var g=yubikey_getdata("fromwebsite");console_log("server.js : Requesting "+d+" C");lpMakeRequest(base_url+d,b,e,f,g)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"yubikey_auth_error")}var lpgoogleauthdata={};
function googleauth_getotp(a,c){grid_setdata("active","1");lpdbg("googleauth","Asking user for fresh otp");var b=c&&c.getAttribute("trustexpired")?c.getAttribute("trustexpired"):0,d=c&&c.getAttribute("trustlabel")?c.getAttribute("trustlabel"):"";openURL(getchromeurl("lp_toolstrip.html?browseraction=1&googleauth=1&trustexpired="+encodeURIComponent(b)+"&trustlabel="+encodeURIComponent(d)));return""}function googleauth_setdata(a,c){lpgoogleauthdata[a]=c}
function googleauth_getdata(a){return"undefined"==typeof lpgoogleauthdata[a]?null:lpgoogleauthdata[a]}function googleauth_cleardata(){lpdbg("googleauth","clearing data");lpgoogleauthdata={}}
function googleauth_auth(a,c){grid_setdata("active",null);if(""!=a)if("1"==googleauth_getdata("offline")){var b=a.substring(0,12);a=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+b)+b));googleauth_setdata("password_offline",a);offlineloginsuccessful("offline",0);lpReadAcctsData();googleauth_setdata("offline","0")}else{var d=b=null,e=null,f=null;googleauth_getdata("postdata")?(b=googleauth_getdata("postdata")+"&otp="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,f=lpLoginError):(b=sesame_getdata("logincheckpostdata")+
"&otp="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);""!=c&&(b+="&trustlabel="+encodeURIComponent(c));var g=googleauth_getdata("fromwebsite");console_log("server.js : Requesting "+d+" C");lpMakeRequest(base_url+d,b,e,f,g)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"googleauth_auth_error")}var lpoutofbanddata={};
function outofband_getotp(a,c){grid_setdata("active","1");lpdbg("outofband","Asking user for fresh otp");var b=c&&c.getAttribute("trustexpired")?c.getAttribute("trustexpired"):0,d=c&&c.getAttribute("trustlabel")?c.getAttribute("trustlabel"):"";g_trustlabel="";"1"==c.getAttribute("preferduowebsdk")?(lpTurnOffIcon(),openbaseurl("duo.php?canexpire=1&cansetuuid=1&username="+encodeURIComponent(g_username)+"&trustexpired="+encodeURIComponent(b)+"&trustlabel="+encodeURIComponent(d))):openURL(getchromeurl("lp_toolstrip.html?browseraction=1&outofband=1&trustexpired="+
encodeURIComponent(c.getAttribute("trustexpired"))+"&trustlabel="+encodeURIComponent(c.getAttribute("trustlabel"))+"&capabilities="+encodeURIComponent(c.getAttribute("capabilities"))+"&allowtrust="+encodeURIComponent(c.getAttribute("allowtrust"))+"&smshash="+encodeURIComponent(c.getAttribute("smshash"))+"&smstime="+encodeURIComponent(c.getAttribute("smstime"))+"&smsuid="+encodeURIComponent(c.getAttribute("smsuid"))+"&outofbandimage="+encodeURIComponent(AES.bin2hex(c.getAttribute("outofbandimage")))+
"&sms_nextcode="+encodeURIComponent(c.getAttribute("sms_nextcode"))+"&textoverride="+encodeURIComponent(c.getAttribute("textoverride"))));return""}function outofband_setdata(a,c){lpoutofbanddata[a]=c}function outofband_getdata(a){return"undefined"==typeof lpoutofbanddata[a]?null:lpoutofbanddata[a]}function outofband_cleardata(){lpdbg("outofband","clearing data");lpoutofbanddata={}}var g_last_otpcheck,g_otpcheck_complete=!1,g_otpwin_closed=!1,g_trustlabel="";
function outofband_handler(a,c,b){if(!g_otpwin_closed)if(a&&4==a.readyState&&200==a.status&&0<a.responseText.indexOf("outofbandrequired")){if(null!=a.responseXML&&null!=a.responseXML.documentElement&&(a=a.responseXML.documentElement.getElementsByTagName("error"),0<a.length&&(a=a[0].getAttribute("retryid"))&&""!=a&&5E3<=(new Date).getTime()-g_last_otpcheck))postdata=outofband_getdata("postdata")+"&outofbandrequest=1&outofbandretry=1&outofbandretryid="+encodeURIComponent(a),g_last_otpcheck=(new Date).getTime(),
lpMakeRequest(base_url+"login.php",postdata,outofband_handler,c,b)}else g_otpcheck_complete=!0,closecurrenttab("lp_toolstrip.html?browseraction=1&outofband=1"),lpLoginResponse(a,c,b),""!=g_trustlabel&&(null!=a.responseXML&&null!=a.responseXML.documentElement&&0<a.responseXML.documentElement.getElementsByTagName("ok").length)&&getuuid(function(a){lpMakeRequest(base_url+"trust.php","canexpire=1&cansetuuid=1&uuid="+encodeURIComponent(a)+"&trustlabel="+encodeURIComponent(g_trustlabel),function(a){if(a&&
4==a.readyState&&200==a.status&&a.responseXML&&a.responseXML.documentElement&&(a=a.responseXML.documentElement.getElementsByTagName("ok"))&&0<a.length&&a[0].hasAttribute("trustuuid"))(a=a[0].getAttribute("trustuuid"))&&""!=a&&setuuid(a,g_username_hash)});g_trustlabel=""},g_username_hash)}
function outofband_auth(a,c){grid_setdata("active",null);if(""!=a)if(g_otpcheck_complete="dummy"!=a,g_otpwin_closed="dummy"!=a,"1"==outofband_getdata("offline")){var b=a.substring(0,12);a=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+b)+b));outofband_setdata("password_offline",a);offlineloginsuccessful("offline",0);lpReadAcctsData();outofband_setdata("offline","0")}else{var d=b=null,e=null;outofband_getdata("postdata")?(b=outofband_getdata("postdata"),d="login.php",e=lpLoginError):(b=sesame_getdata("logincheckpostdata"),
d="login_check.php",e=lpLoginCheckError);"dummy"!=a&&(b+="&otp="+encodeURIComponent(a));""!=c&&(b+="&trustlabel="+encodeURIComponent(c));var b=b+"&outofbandrequest=1",f=outofband_getdata("fromwebsite");console_log("server.js : Requesting "+d+" C");g_last_otpcheck=(new Date).getTime();lpMakeRequest(base_url+d,b,"dummy"==a?outofband_handler:lpLoginResponse,e,f)}else g_otpcheck_complete||(g_otpwin_closed=!0,lpshowError("LoginError",!1,!0),loggedOut(!1,"outofband_auth_error"))}
var lpsecurityquestiondata={};
function securityquestion_getotp(a,c){if(c.getAttribute("redirecturl"))openURL(c.getAttribute("redirecturl"));else return grid_setdata("active","1"),lpdbg("securityquestion","Asking user for fresh otp"),getuuid(function(a){openURL(getchromeurl("lp_toolstrip.html?browseraction=1&securityquestion=1&trustexpired="+encodeURIComponent(c.getAttribute("trustexpired"))+"&trustlabel="+encodeURIComponent(c.getAttribute("trustlabel"))+"&uuid="+encodeURIComponent(a)+"&question="+encodeURIComponent(c.getAttribute("question"))+
"&autotrust="+encodeURIComponent(c.getAttribute("autotrust"))+"&hidedisable="+encodeURIComponent(c.getAttribute("hidedisable"))+"&reseturl="+encodeURIComponent(c.getAttribute("reseturl"))));securityquestion_setdata("reseturl",c.getAttribute("reseturl"))},g_username_hash),""}function securityquestion_setdata(a,c){lpsecurityquestiondata[a]=c}function securityquestion_getdata(a){return"undefined"==typeof lpsecurityquestiondata[a]?null:lpsecurityquestiondata[a]}
function securityquestion_cleardata(){lpdbg("securityquestion","clearing data");lpsecurityquestiondata={}}
function securityquestion_auth(a,c){grid_setdata("active",null);if(""!=a)if("1"==securityquestion_getdata("offline")){var b=a.substring(0,12);a=SHA256(SHA256(SHA256(fix_username("LastPassIsGreat")+b)+b));securityquestion_setdata("password_offline",a);offlineloginsuccessful("offline",0);lpReadAcctsData();securityquestion_setdata("offline","0")}else{var d=b=null,e=null,f=null;securityquestion_getdata("postdata")?(b=securityquestion_getdata("postdata")+"&otp="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,
f=lpLoginError):(b=sesame_getdata("logincheckpostdata")+"&otp="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);""!=c&&(b+="&trustlabel="+encodeURIComponent(c));var g=securityquestion_getdata("fromwebsite");console_log("server.js : Requesting "+d+" C");lpMakeRequest(base_url+d,b,e,f,g)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"securityquestion_auth_error")}var lpsesamedata={},lpsesameotp=null;
function sesame_setotp(a){lpdbg("sesame","browser forwarded OTP => sesame_setotp called");lpsesameotp=a}
function sesame_getotp(a,c){grid_setdata("active","1");if(a&&lpsesameotp){lpdbg("sesame","Not requesting OTP - using value passed to browser");var b=lpsesameotp;lpsesameotp=null;sesame_auth(b,"");return b}lpdbg("sesame","Asking user for fresh otp");var b=c&&c.getAttribute("trustexpired")?c.getAttribute("trustexpired"):0,d=c&&c.getAttribute("trustlabel")?c.getAttribute("trustlabel"):"";openURL(getchromeurl("lp_toolstrip.html?browseraction=1&sesame=1&trustexpired="+encodeURIComponent(b)+"&trustlabel="+
encodeURIComponent(d)));return""}function sesame_setdata(a,c){lpsesamedata[a]=c}function sesame_getdata(a){return"undefined"==typeof lpsesamedata[a]?null:lpsesamedata[a]}function sesame_cleardata(){lpdbg("sesame","clearing data");lpsesamedata={}}
function sesame_auth(a,c){grid_setdata("active",null);if(""!=a)if("1"==sesame_getdata("offline"))sesame_setdata("password_offline",a),offlineloginsuccessful("offline",0),lpReadAcctsData(),sesame_setdata("offline","0");else{var b=null,d=null,e=null,f=null;sesame_getdata("postdata")?(b=sesame_getdata("postdata")+"&sesameotp="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,f=lpLoginError):(b=sesame_getdata("logincheckpostdata")+"&sesameotp="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,
f=lpLoginCheckError);""!=c&&(b+="&trustlabel="+encodeURIComponent(c));var g=sesame_getdata("fromwebsite");console_log("server.js : Requesting "+d+" D");lpMakeRequest(base_url+d,b,e,f,g)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"sesame_auth_error")}var lpgriddata={},lpgridvalues=null;
function grid_getvalues(a,c,b){grid_setdata("active","1");openURL(getchromeurl("lp_toolstrip.html?browseraction=1&grid=1&trustexpired="+encodeURIComponent(b.getAttribute("trustexpired"))+"&trustlabel="+encodeURIComponent(b.getAttribute("trustlabel"))+"&challenge="+encodeURIComponent(c)))}function grid_setdata(a,c){lpgriddata[a]=c}function grid_getdata(a){return"undefined"==typeof lpgriddata[a]?null:lpgriddata[a]}function grid_cleardata(){lpdbg("grid","clearing data");lpgriddata={}}
function grid_auth(a,c){grid_setdata("active",null);if(""!=a){var b=null,d=null,e=null,f=null;grid_getdata("postdata")?(b=grid_getdata("postdata")+"&gridresponse="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,f=lpLoginError):(b=sesame_getdata("logincheckpostdata")+"&gridresponse="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);""!=c&&(b+="&trustlabel="+encodeURIComponent(c));grid_getdata("wxsessid")&&(b+="&wxsessid="+encodeURIComponent(grid_getdata("wxsessid")));
var g=grid_getdata("fromwebsite");console_log("server.js : Requesting "+d+" E");lpMakeRequest(base_url+d,b,e,f,g)}else lpshowError("LoginError",!1,!0),loggedOut(!1,"grid_auth_error")}var lpmultifactordata={},lpmultifactorresponse=null;
function multifactor_getresponse(a,c){var b="";multifactor_setdata("active","1");var d=multifactor_getdata("type"),e="";multifactor_getdata("type")==d&&(e=multifactor_getdata("password_offline"));if(!e||64!=e.length)e=SHA256(SHA256(fix_username(a)+d));var f=function(){multifactor_setdata("password_offline",e);multifactor_setdata("type",d);if(c){if("omnikey"==d){omnikey_get_pin(function(a){have_binary_function("omnikey_decrypt")?call_binary_function("omnikey_decrypt",c,a,function(a){b=a;multifactor_auth(b,
"")}):multifactor_auth(b,"")});return}b=""!=e?SHA256(e+c):""}else b=e;multifactor_auth(b,"")};(!e||64!=e.length)&&"trueapi"==d&&have_binary_function("trueapi_get_hash")?call_binary_function("trueapi_get_hash",a,function(a){e=a;f()}):f()}function multifactor_setdata(a,c){lpmultifactordata[a]=c}function multifactor_getdata(a){return"undefined"==typeof lpmultifactordata[a]?null:lpmultifactordata[a]}function multifactor_cleardata(){lpdbg("multifactor","clearing data");lpmultifactordata={}}
function multifactor_auth(a,c){multifactor_setdata("active",null);if(""!=a)if("1"==multifactor_getdata("offline"))multifactor_setdata("password_offline",a),"omnikey"!=multifactor_getdata("type")&&multifactor_setdata("type","trueapi"),offlineloginsuccessful("offline",0),lpReadAcctsData(),multifactor_setdata("offline","0");else{var b=null,d=null,e=null,f=null;multifactor_getdata("postdata")?(b=multifactor_getdata("postdata")+"&multifactorresponse="+encodeURIComponent(a),d="login.php",e=lpLoginResponse,
f=lpLoginError):(b=sesame_getdata("logincheckpostdata")+"&multifactorresponse="+encodeURIComponent(a),d="login_check.php",e=lpLoginCheckResponse,f=lpLoginCheckError);""!=c&&(b+="&trustlabel="+encodeURIComponent(c));multifactor_getdata("wxsessid")&&(b+="&wxsessid="+encodeURIComponent(multifactor_getdata("wxsessid")));multifactor_getdata("type")&&(b+="&type="+encodeURIComponent(multifactor_getdata("type")));var g=multifactor_getdata("fromwebsite");console_log("server.js : Requesting "+d+" F");lpMakeRequest(base_url+
d,b,e,f,g)}else lpshowError("LoginError",!1,!0,!1,get_multifactor_disable_url(g_username,multifactor_getdata("type"))),loggedOut(!1,"multifactor_auth_error")}function multifactor_response(a,c){lpdbg("multifactor","in multifactor_response");"undefined"!=typeof a.callback?(lpdbg("multifactor","calling callback"),a.callback(c)):sendCS(a.tabid,c,a.docnum)}
function lpSetupMultifactorResponse(a,c,b){lpdbg("multifactor","setupmultifactorresponse: "+a.readyState);if(4==a.readyState){lpdbg("multifactor","setupmultifactorresponse: "+a.status);if(200==a.status&&(null!=a.responseXML&&null!=a.responseXML.documentElement)&&(a=a.responseXML.documentElement.getElementsByTagName("ok"),0<a.length)){var d=a[0].getAttribute("type");lpdbg("multifactor","setupmultifactorresponse: "+d);var e=a[0].getAttribute("hash");if("trueapi"==d)if("undefined"!=typeof b.password){if(have_binary_function("trueapi_store_default_login")){call_binary_function("trueapi_store_hash",
g_username,e,function(a){if(a){var c=function(a){a==e?call_binary_function("trueapi_store_default_login",g_username,b.password,e,function(a){a?(setsinglefactortype(d),"1"!=b.silent&&multifactor_response(b,{cmd:"setupsinglefactor",result:"done"})):lpSetupMultifactorError(b)}):lpSetupMultifactorError(b)};"1"==b.silent?c(e):call_binary_function("trueapi_get_hash",g_username,function(a){c(a)})}else lpSetupMultifactorError(b)});return}}else{if("1"!=b.silent&&have_binary_function("trueapi_store_hash")){call_binary_function("trueapi_store_hash",
g_username,e,function(a){a?call_binary_function("trueapi_get_hash",g_username,function(a){a==e?multifactor_response(b,{cmd:"setupmultifactor",result:"done"}):lpSetupMultifactorError(b)}):lpSetupMultifactorError(b)});return}}else if("vtapi"==d){if(have_binary_function("lpvt_store_data")){call_binary_function("lpvt_store_data",encodeURIComponent(g_username)+"|"+encodeURIComponent(b.password),gs("Swipe finger"),gs("Swipe your finger on the fingerprint sensor"),gs("Cancel"),gs("Swipe current user's finger"),
function(a){a?(setsinglefactortype(d),"1"!=b.silent&&multifactor_response(b,{cmd:"setupsinglefactor",result:"done"})):lpSetupMultifactorError(b)});return}}else if("validity"==d){if(have_binary_function("validity_store_data")){call_binary_function("validity_store_data",encodeURIComponent(g_username)+"|"+encodeURIComponent(b.password),gs("Swipe finger"),gs("Swipe your finger on the fingerprint sensor"),gs("Cancel"),function(a){a?(setsinglefactortype(d),"1"!=b.silent&&multifactor_response(b,{cmd:"setupsinglefactor",
result:"done"})):lpSetupMultifactorError(b)});return}}else if("winbio"==d){if(have_binary_function("winbio_store_data")){call_binary_function("winbio_has_fingerprints",function(a){lpdbg("multifactor","winbio_has_fingerprints: "+a);a?call_binary_function("winbio_store_data",encodeURIComponent(g_username)+"|"+encodeURIComponent(b.password),gs("Swipe finger"),gs("Swipe your finger on the fingerprint sensor"),gs("Cancel"),function(a){lpdbg("multifactor","winbio_store_data: "+a);a?(setsinglefactortype(d),
"1"!=b.silent&&(lpdbg("multifactor","calling multifactor_response"),multifactor_response(b,{cmd:"setupsinglefactor",result:"done"}))):lpSetupMultifactorError(b)}):(have_binary_function("winbio_launch_enrollment")&&call_binary_function("winbio_launch_enrollment"),"1"!=b.silent&&multifactor_response(b,{cmd:"setupsinglefactor",result:"notenrolled"}))});return}}else{if("nymi"==d){have_binary_function("nymi_provision")&&call_binary_function("nymi_provision",encodeURIComponent(g_username)+"|"+encodeURIComponent(b.password),
function(a){lpdbg("multifactor","nymi_provision: "+a);a?(setsinglefactortype(d),"1"!=b.silent&&(lpdbg("multifactor","calling multifactor_response"),call_binary_function("nymi_read_data",function(a){multifactor_response(b,{cmd:"setupsinglefactor",result:"done_"+a})}))):lpSetupMultifactorError(b)});return}if("omnikey"==d){multifactor_response(b,{cmd:"setupsinglefactor",result:"done"});return}}}lpSetupMultifactorError(b)}}
function lpSetupMultifactorError(a){1!=a.silent&&multifactor_response(a,{cmd:"undefined"!=typeof a.password?"setupsinglefactor":"setupmultifactor",result:"error"})}function get_multifactor_disable_url(a,c){return"multifactordisable.php?cmd=sendemail&username="+en(a)+"&type="+en(c)}function lp_StartLogin(a,c){console_log("server.js : lp_StartLogin fromlogincheckack="+a);g_loginstarted||(g_loginstarted=!0,a?(rsa_setpendingsharests(),lplogincheck("frompipes",c)):httptest())}
function can_chrome_do_math(){return"cf80cd8aed482d5d1527d7dc72fceff84e6326592848447d2dc0b0e87dfc9a90"!=SHA256("testing")?!1:!0}
function lpDownloadDataResponse(a,c,b){if(a&&200==a.status&&4==a.readyState){c="";a=a.responseText.split("\n");for(var d=0;d<a.length;d++)if(0==a[d].indexOf("ff_")){var e=a[d].indexOf("=");if(-1!=e){var f=a[d].substr(0,e),e=a[d].substr(e+1),e=CheckStringForObfuscation(f,"",e);c+=f+"="+e+"\n"}}else c+=a[d]+"\n";localStorage_setItem(b,c);"ff.dat"==b?ApplyAllOverrides():"sites.dat"==b?LoadSpecialSites():"bigicon.dat"==b&&LoadBigIconList()}}
function checkIterationsInDataFile(a){var c=get_key_iterations(g_username),b=a.substring(0,20);return 0==b.indexOf("iterations=")?(b=/iterations=(\d*);/.exec(b),1<b.length&&c==b[1]?a.substring(a.indexOf(";")+1):"iterationserror"):1!=c?"iterationserror":a}function prependIterations(a){var c=get_key_iterations(g_username);1<c&&(a="iterations="+c+";"+a);return a}
function checkIterationsReductionOk(a){var c=SHA256(g_username)+"_key_iter";return"undefined"!=typeof localStorage&&null!=localStorage_getItem(c)&&localStorage_getItem(c)>a&&g_checkiterationsreduction?confirm(gs("IterationsReduction")):!0}function pref_numeric_validate(a,c){var b=parseInt(a);return 0>b||isNaN(b)?c:b};
